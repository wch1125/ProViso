import{j as e,k as xt,l as te,f as _t,m as $e}from"./index-DxtHVOyo.js";import{r as g,f as Ut}from"./vendor-react-C-GM1j7h.js";import{C as U,b as B,c as q,B as I,a as xe}from"./Card-C2sliWi2.js";import{C as Bt,a as be,S as Ne,b as zt}from"./ActivityFeed-BtwJ7Rzb.js";import{S as X,I as J,E as mt}from"./Select-XmEcim9I.js";import{t as Ee,m as Be,Y as Q,K as se,p as V,a5 as z,T as ie,D as re,z as ut,d as ee,a2 as ht,C as ne,X as ze,a6 as pt,a7 as gt,n as Vt,a8 as ft,q as Ve,a9 as Gt,aa as qt,_ as Wt,ab as Ht,f as Ge,M as Yt,b as Ke,Z as jt,A as Te,I as qe,r as Ce,F as ue,v as bt,ac as Qt,V as Kt,N as Zt,J as Ze,o as me,u as Nt,a as Xt,ad as Jt,ae as es,af as ts,R as ss,ag as We,a3 as we,ah as Oe,ai as as,x as vt,y as rs,g as ns}from"./vendor-icons-SDImLkab.js";import{T as is,a as ls,b as Re,c as Ie,D as ve,e as ye}from"./Tabs-DEopNXL3.js";import{c as cs,R as fe,L as yt,a as He,b as wt,B as Ct,X as Se,Y as Ae,T as De,d as Et,C as Tt,e as St,f as os,A as ds,g as xs}from"./vendor-charts-DE_Rm1Qj.js";import{S as At,C as Dt,b as ms,g as us,D as hs}from"./DiffViewer-CN0rGMIP.js";import{M as le}from"./Modal-C-GMRyqk.js";import{a as ps,b as Xe,c as gs}from"./analytics-CJOMXrsP.js";import{T as Je}from"./TextArea-DWjsZe0p.js";import{c as fs,g as js,d as bs}from"./versionDiff-evT-6Elz.js";import"./TopNav-BMcoUvFj.js";function Fe({title:t,subtitle:n,children:s,defaultExpanded:r=!1,forceExpanded:l=!1,icon:i,headerActions:c,className:d="",onExpandChange:x}){const[a,o]=g.useState(r||l);g.useEffect(()=>{l&&!a&&(o(!0),x==null||x(!0))},[l,a,x]);const m=()=>{if(l&&a)return;const p=!a;o(p),x==null||x(p)},h=a?Ee:Be;return e.jsxs(U,{className:d,children:[e.jsxs("button",{type:"button",onClick:m,className:`w-full text-left px-5 py-4 flex items-center justify-between ${l&&a?"cursor-default":"cursor-pointer hover:bg-industry-cardBgHover/50"} transition-colors rounded-t-xl ${a?"":"rounded-b-xl"}`,disabled:l&&a,"aria-expanded":a,children:[e.jsxs("div",{className:"flex items-center gap-3 min-w-0",children:[e.jsx(h,{className:`w-5 h-5 text-industry-textMuted flex-shrink-0 transition-transform ${l?"opacity-50":""}`}),i&&e.jsx("span",{className:"flex-shrink-0",children:i}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("h3",{className:"text-sm font-medium text-industry-textPrimary truncate",children:t}),n&&e.jsx("p",{className:"text-xs text-industry-textMuted mt-0.5 truncate",children:n})]})]}),c&&e.jsx("div",{className:"flex items-center gap-2 ml-4 flex-shrink-0",onClick:p=>p.stopPropagation(),children:c})]}),a&&e.jsx(B,{className:"pt-0 border-t border-industry-borderDefault",children:s})]})}const Ns={compliant:{className:"status-badge-compliant",defaultLabel:"Compliant"},breach:{className:"status-badge-breach",defaultLabel:"Breach"},warning:{className:"status-badge-warning",defaultLabel:"At Risk"},suspended:{className:"status-badge-suspended",defaultLabel:"Suspended"},pending:{className:"status-badge-pending",defaultLabel:"Pending"},achieved:{className:"status-badge-compliant",defaultLabel:"Achieved"}};function Z({status:t,label:n}){const s=Ns[t];return e.jsx("span",{className:cs("status-badge",s.className),children:n??s.defaultLabel})}function et({data:t,height:n=24,width:s="100%",color:r="currentColor",threshold:l,thresholdColor:i="#ef4444",showDots:c=!1,className:d=""}){const x=t.map((a,o)=>({index:o,value:a}));return e.jsx("div",{className:`inline-flex items-center ${d}`,style:{width:s,height:n},children:e.jsx(fe,{width:"100%",height:"100%",children:e.jsxs(yt,{data:x,margin:{top:2,right:2,bottom:2,left:2},children:[l!==void 0&&e.jsx(He,{y:l,stroke:i,strokeDasharray:"2 2",strokeWidth:1}),e.jsx(wt,{type:"monotone",dataKey:"value",stroke:r,strokeWidth:1.5,dot:c?{r:2,fill:r}:!1,activeDot:!1,isAnimationActive:!1})]})})})}const vs={cautionAt:.8,dangerAt:.9};function ce(t,n,s,r=vs){const l=s==="<="||s==="<";let i;return l?i=t/n:i=n/t,i>1?"breach":i>=r.dangerAt?"danger":i>=r.cautionAt?"caution":"safe"}function $t(t,n,s){return s==="<="||s==="<"?t/n*100:n/t*100}function _e(t,n,s){const r=s==="<="||s==="<",l=$t(t,n,s);let i;return r?i=n-t:i=t-n,{percent:Math.max(0,100-l),absolute:i,isInBreach:l>100}}const ys={safe:{bgColor:"bg-success/10",textColor:"text-success",borderColor:"border-success/30",progressColor:"bg-gradient-to-r from-emerald-600 to-success",pulseAnimation:!1,icon:"check"},caution:{bgColor:"bg-warning/10",textColor:"text-warning",borderColor:"border-warning/30",progressColor:"bg-gradient-to-r from-amber-600 to-warning",pulseAnimation:!1,icon:"warning"},danger:{bgColor:"bg-orange-500/10",textColor:"text-orange-400",borderColor:"border-orange-500/30",progressColor:"bg-gradient-to-r from-orange-600 to-orange-500",pulseAnimation:!0,icon:"alert"},breach:{bgColor:"bg-danger/10",textColor:"text-danger",borderColor:"border-danger/30",progressColor:"bg-gradient-to-r from-red-600 to-danger",pulseAnimation:!0,icon:"x"}};function Ye(t){return ys[t]}function ws(t){const n=[];let s=0,r=0,l=0;for(const d of t){if(d.suspended)continue;const x=ce(d.actual,d.required,d.operator);if(x!=="safe"){const a=$t(d.actual,d.required,d.operator),o=d.name.replace(/([A-Z])/g," $1").trim();let m;switch(x){case"breach":m=`${o} in breach`,s++;break;case"danger":m=`${o} at ${a.toFixed(0)}% of threshold`,r++;break;case"caution":m=`${o} at ${a.toFixed(0)}% of threshold`,l++;break;default:m=""}n.push({name:d.name,zone:x,utilization:a,message:m})}}n.sort((d,x)=>{const a={breach:0,danger:1,caution:2,safe:3};return a[d.zone]!==a[x.zone]?a[d.zone]-a[x.zone]:x.utilization-d.utilization});const i=n.length>0;let c="";if(s>0?c=`${s} covenant${s>1?"s":""} in breach`:r>0?c=`${r} covenant${r>1?"s":""} approaching threshold`:l>0&&(c=`${l} covenant${l>1?"s":""} to monitor`),i&&n.length<=2){const d=n.map(x=>x.name.replace(/([A-Z])/g," $1").trim());c+=`: ${d.join(", ")}`}return{hasAlerts:i,breachCount:s,dangerCount:r,cautionCount:l,alerts:n,message:c}}function Cs(t,n){let s=0;const r=`${t}-${n}`;for(let l=0;l<r.length;l++)s=(s<<5)-s+r.charCodeAt(l)|0;return(s&2147483647)%1e3/1e3}function tt(t,n=6,s=.1,r="default"){const l=[];let i=t*(1-s*(n/2)*.5);for(let c=0;c<n-1;c++){l.push(i);const d=(t-i)/(n-c),x=(Cs(r,c)-.5)*t*s*.5;i+=d+x}return l.push(t),l}function Es({data:t}){const{colors:n}=xt(),s=t.covenants.length,r=t.covenants.filter(y=>!y.suspended),l=r.filter(y=>y.compliant).length,i=r.length,c=t.milestones.filter(y=>y.status==="achieved").length,d=t.milestones.filter(y=>y.status==="at_risk"||y.status==="breached").length,x=t.reserves.reduce((y,b)=>y+b.balance,0),a=t.reserves.reduce((y,b)=>y+b.target,0),o=a>0?x/a*100:0,m=t.waterfall.tiers.filter(y=>!y.blocked).reduce((y,b)=>y+b.amount,0),h=t.waterfall.tiers.filter(y=>y.blocked).reduce((y,b)=>y+b.amount,0),p=r.every(y=>y.compliant),u=d>0||h>0,j=ws(r.map(y=>({name:y.name,actual:y.actual,required:y.required,operator:y.operator,suspended:y.suspended}))),N=!p||u||j.hasAlerts,E=g.useMemo(()=>tt(o,6,.08,"reserve-funding"),[o]),D=g.useMemo(()=>tt(t.waterfall.revenue,6,.12,"waterfall-revenue"),[t.waterfall.revenue]);return e.jsx(U,{className:"col-span-full",children:e.jsxs(B,{className:"p-0",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 divide-y md:divide-y-0 md:divide-x divide-industry-borderDefault",children:[e.jsxs("div",{className:"p-5",children:[e.jsx("div",{className:"flex items-start justify-between",children:e.jsxs("div",{children:[e.jsx("p",{className:"metric-label mb-1",children:"Overall Status"}),e.jsxs("div",{className:"flex items-center gap-2",children:[p?j.dangerCount>0?e.jsx(se,{className:"w-6 h-6 text-orange-500 animate-pulse"}):j.cautionCount>0?e.jsx(V,{className:"w-6 h-6 text-warning"}):e.jsx(z,{className:"w-6 h-6 text-success"}):e.jsx(Q,{className:"w-6 h-6 text-danger"}),e.jsx("span",{className:`text-xl font-semibold ${p?j.dangerCount>0?"text-orange-400":j.cautionCount>0?"text-warning":"text-success":"text-danger"}`,children:p?j.dangerCount>0?"At Risk":j.cautionCount>0?"Monitor":"Compliant":"Breach"})]})]})}),e.jsxs("p",{className:"text-sm text-text-muted mt-3",children:[l,"/",i," active covenants passing",s-i>0&&e.jsxs("span",{className:"text-text-muted",children:[" (",s-i," suspended)"]})]})]}),e.jsxs("div",{className:"p-5",children:[e.jsx("div",{className:"flex items-start justify-between",children:e.jsxs("div",{children:[e.jsx("p",{className:"metric-label mb-1",children:"Milestones"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ie,{className:"w-6 h-6 text-industry-primary",style:{color:n.primary}}),e.jsxs("span",{className:"metric-value",children:[c,"/",t.milestones.length]})]})]})}),e.jsx("p",{className:"text-sm text-text-muted mt-3",children:d>0?e.jsxs("span",{className:"text-warning",children:[d," at risk or breached"]}):"All milestones on track"})]}),e.jsxs("div",{className:"p-5",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"metric-label mb-1",children:"Reserve Funding"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(re,{className:"w-6 h-6 text-industry-primary",style:{color:n.primary}}),e.jsxs("span",{className:"metric-value",children:[o.toFixed(0),"%"]})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx(et,{data:E,height:28,width:64,color:o>=80?"#10b981":o>=50?"#f59e0b":"#ef4444",threshold:100,thresholdColor:"#10b981"}),e.jsx("span",{className:"text-[9px] text-text-muted/50 leading-none",children:"Simulated"})]})]}),e.jsxs("p",{className:"text-sm text-text-muted mt-3",children:["$",(x/1e6).toFixed(1),"M of $",(a/1e6).toFixed(1),"M target"]})]}),e.jsxs("div",{className:"p-5",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"metric-label mb-1",children:"Monthly Revenue"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(re,{className:"w-6 h-6 text-industry-primary",style:{color:n.primary}}),e.jsxs("span",{className:"metric-value",children:["$",(t.waterfall.revenue/1e6).toFixed(1),"M"]})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx(et,{data:D,height:28,width:64,color:h>0?"#f59e0b":"#10b981"}),e.jsx("span",{className:"text-[9px] text-text-muted/50 leading-none",children:"Simulated"})]})]}),e.jsx("p",{className:"text-sm text-text-muted mt-3",children:h>0?e.jsxs("span",{className:"text-warning",children:["$",(h/1e6).toFixed(1),"M blocked"]}):`$${(m/1e6).toFixed(1)}M distributed`})]}),e.jsxs("div",{className:"p-5",children:[e.jsx("div",{className:"flex items-start justify-between",children:e.jsxs("div",{children:[e.jsx("p",{className:"metric-label mb-1",children:"COD Target"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ut,{className:"w-6 h-6 text-industry-primary",style:{color:n.primary}}),e.jsx("span",{className:"metric-value text-lg",children:t.phase.codTarget?new Date(t.phase.codTarget).toLocaleDateString("en-US",{month:"short",year:"numeric"}):"N/A"})]})]})}),e.jsx("p",{className:"text-sm text-text-muted mt-3",children:t.phase.codTarget?`${Ss(t.phase.codTarget)} days remaining`:"No target set"})]})]}),N&&e.jsx(Ts,{allCompliant:p,alertSummary:j,milestonesAtRisk:d,hasBlockedDistribution:h>0,blockedReasons:t.waterfall.tiers.filter(y=>y.blocked&&y.reason).map(y=>y.reason)})]})})}function Ts({allCompliant:t,alertSummary:n,milestonesAtRisk:s,hasBlockedDistribution:r,blockedReasons:l}){let i="caution";const c=[];if(t||(i="critical",c.push("Covenant breach detected - review required")),n.dangerCount>0){i!=="critical"&&(i="warning");const m=n.alerts.filter(h=>h.zone==="danger").slice(0,2).map(h=>h.name.replace(/([A-Z])/g," $1").trim());c.push(`${n.dangerCount} covenant${n.dangerCount>1?"s":""} approaching threshold: ${m.join(", ")}`)}if(n.cautionCount>0&&c.length<2&&c.push(`${n.cautionCount} covenant${n.cautionCount>1?"s":""} to monitor`),s>0&&c.length<2&&(i!=="critical"&&(i="warning"),c.push(`${s} milestone${s>1?"s":""} at risk`)),r&&c.length<2){const o=l!=null&&l.length?l.join("; "):"gate condition not met";c.push(`Distribution blocked - ${o}`)}const d=i==="critical"?"bg-danger/5 border-danger/20":i==="warning"?"bg-orange-500/5 border-orange-500/20":"bg-warning/5 border-warning/20",x=i==="critical"?"text-danger":i==="warning"?"text-orange-400":"text-warning",a=i==="critical"?Q:i==="warning"?se:V;return e.jsx("div",{className:`px-5 py-3 border-t ${d}`,children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(a,{className:`w-4 h-4 ${x} flex-shrink-0 mt-0.5 ${i==="warning"?"animate-pulse":""}`}),e.jsx("div",{className:"flex flex-col gap-0.5",children:c.map((o,m)=>e.jsx("span",{className:`text-sm ${m===0?`font-medium ${x}`:"text-text-tertiary"}`,children:o},m))})]})})}function Ss(t){const n=new Date(t),s=new Date,r=n.getTime()-s.getTime();return Math.ceil(r/(1e3*60*60*24))}function As({phase:t}){const n=[{name:"Financial Close",date:t.constructionStart,status:"completed"},{name:"Construction",date:t.constructionStart,status:t.current==="construction"?"current":"completed"},{name:"COD",date:t.codTarget,status:t.current==="operations"?"completed":"upcoming"},{name:"Operations",date:t.codTarget,status:t.current==="operations"?"current":"upcoming"},{name:"Maturity",date:t.maturity,status:"upcoming"}],s=new Date(t.constructionStart),r=new Date(t.codTarget),l=new Date(t.maturity),i=new Date;let c=0;if(t.current==="construction"){const d=r.getTime()-s.getTime(),x=i.getTime()-s.getTime();c=Math.min(50,x/d*50)}else if(t.current==="operations"){const d=l.getTime()-r.getTime(),x=i.getTime()-r.getTime();c=50+Math.min(50,x/d*50)}return e.jsxs(U,{children:[e.jsx(q,{title:"Project Timeline",subtitle:"Construction to Maturity"}),e.jsxs(B,{children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute top-4 left-0 right-0 h-1 bg-surface-2 rounded-full"}),e.jsx("div",{className:"absolute top-4 left-0 h-1 bg-gradient-to-r from-gold-600 to-gold-400 rounded-full transition-all duration-1000",style:{width:`${c}%`}}),e.jsx("div",{className:"relative flex justify-between",children:n.map((d,x)=>e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center z-10 ${d.status==="completed"?"bg-gold-600":d.status==="current"?"bg-gold-500 ring-4 ring-gold-500/20":"bg-surface-2"}`,children:d.status==="completed"?e.jsx(z,{className:"w-5 h-5 text-text-primary"}):d.status==="current"?e.jsx(ee,{className:"w-4 h-4 text-text-primary animate-pulse"}):e.jsx(ht,{className:"w-4 h-4 text-text-muted"})}),e.jsxs("div",{className:"mt-3 text-center",children:[e.jsx("p",{className:`text-sm font-medium ${d.status==="current"?"text-gold-500":d.status==="completed"?"text-text-secondary":"text-text-muted"}`,children:d.name}),e.jsx("p",{className:"text-xs text-text-muted mt-0.5",children:new Date(d.date).toLocaleDateString("en-US",{month:"short",year:"numeric"})})]})]},x))})]}),e.jsx("div",{className:"mt-8 pt-4 border-t border-border-DEFAULT",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-text-tertiary",children:"Current Phase"}),e.jsx("p",{className:"text-lg font-medium text-text-primary capitalize",children:t.current})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-sm text-text-tertiary",children:"Next Milestone"}),e.jsxs("p",{className:"text-lg font-medium text-gold-500",children:["COD -"," ",new Date(t.codTarget).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})]})]})]})})]})]})}const Ds={compliant:"text-emerald-400 font-semibold",breach:"text-red-400 font-semibold",cured:"text-amber-400 font-semibold",suspended:"text-gray-400 font-semibold",at_risk:"text-amber-400 font-semibold",achieved:"text-emerald-400 font-semibold",pending:"text-gray-400 font-semibold"};function st(t){const n=/(COMPLIANT|BREACH|BREACHED|CURED|SUSPENDED|AT RISK|ACHIEVED|FULLY UTILIZED|FULLY FUNDED|BELOW MINIMUM|ON TRACK|PENDING)/gi;return t.split(n).map((r,l)=>{const i=r.toUpperCase();let c=null;return i==="COMPLIANT"||i==="FULLY FUNDED"||i==="ACHIEVED"||i==="ON TRACK"?c="compliant":i==="BREACH"||i==="BREACHED"||i==="FULLY UTILIZED"||i==="BELOW MINIMUM"?c="breach":i==="CURED"?c="cured":i==="SUSPENDED"?c="suspended":i==="AT RISK"?c="at_risk":i==="PENDING"&&(c="pending"),c?e.jsx("span",{className:Ds[c],children:r},l):r})}function ke({summary:t,detail:n,className:s=""}){return e.jsxs("div",{className:`text-sm ${s}`,children:[e.jsx("p",{className:"text-gray-300",children:st(t)}),n&&e.jsx("p",{className:"text-gray-500 mt-0.5",children:st(n)})]})}function $s({name:t,actual:n,threshold:s,operator:r,compliant:l,headroom:i,suspended:c,className:d=""}){const x=o=>o>10?o.toFixed(1):`${o.toFixed(2)}x`,a=t.replace(/([A-Z])/g," $1").trim();if(c)return e.jsx(ke,{summary:`${a} is SUSPENDED during current phase.`,className:d});if(l){const o=i!==void 0?` ${x(Math.abs(i))} headroom.`:"";return e.jsx(ke,{summary:`${a} is COMPLIANT at ${x(n)} (${r} ${x(s)}).${o}`,className:d})}return e.jsx(ke,{summary:`${a} is in BREACH at ${x(n)} (${r} ${x(s)}).`,className:d})}function he(t,n){switch(n){case"currency":return Math.abs(t)>=1e9?`$${(t/1e9).toFixed(2)}B`:Math.abs(t)>=1e6?`$${(t/1e6).toFixed(2)}M`:Math.abs(t)>=1e3?`$${(t/1e3).toFixed(0)}K`:`$${t.toFixed(0)}`;case"ratio":return`${t.toFixed(2)}x`;case"percentage":return`${(t*100).toFixed(1)}%`;default:return Number.isInteger(t)?t.toLocaleString():t.toFixed(2)}}function Rt({node:t,depth:n,onShowCode:s}){const[r,l]=g.useState(n<2),i=t.children&&t.children.length>0,c={definition:{icon:ne,color:"text-purple-400",label:"Calculated"},financial_data:{icon:pt,color:"text-emerald-400",label:"Financial Data"},literal:{icon:gt,color:"text-amber-400",label:"Constant"},computed:{icon:ne,color:"text-blue-400",label:"Computed"}},d=c[t.source]??c.computed,x=d.icon;return e.jsxs("div",{className:"font-mono text-sm",children:[e.jsxs("div",{className:`flex items-start gap-2 py-1.5 px-2 rounded hover:bg-slate-800/50 ${i?"cursor-pointer":""}`,onClick:()=>i&&l(!r),children:[e.jsx("div",{className:"w-4 flex-shrink-0",children:i&&(r?e.jsx(Ee,{className:"w-4 h-4 text-gray-500"}):e.jsx(Be,{className:"w-4 h-4 text-gray-500"}))}),e.jsx(x,{className:`w-4 h-4 flex-shrink-0 ${d.color}`}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("span",{className:"text-gray-200",children:t.name}),t.formula&&e.jsxs("span",{className:"text-gray-500 ml-2",children:["= ",t.formula]})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-shrink-0",children:[e.jsx("span",{className:`font-semibold ${d.color}`,children:he(t.value,t.valueType)}),t.source==="financial_data"&&t.rawDataKey&&e.jsx("span",{className:"text-xs text-gray-500 px-1.5 py-0.5 bg-slate-800 rounded",children:"data"}),t.source==="definition"&&s&&e.jsx(Dt,{onClick:()=>{const a=ms({name:t.name,expression:t.formula??t.name});s(t.name,a)}})]})]}),i&&r&&e.jsx("div",{className:"ml-6 border-l border-slate-700 pl-2",children:t.children.map((a,o)=>e.jsx(Rt,{node:a,depth:n+1,onShowCode:s},`${a.name}-${o}`))})]})}function Rs({isOpen:t,onClose:n,rootNode:s,title:r}){const[l,i]=g.useState(!1),[c,d]=g.useState({name:"",code:""}),x=(a,o)=>{d({name:a,code:o}),i(!0)};return e.jsxs(e.Fragment,{children:[e.jsx(le,{isOpen:t,onClose:n,children:e.jsxs("div",{className:"w-full max-w-2xl",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-blue-500/10 rounded-lg",children:e.jsx(ne,{className:"w-5 h-5 text-blue-400"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-white",children:r??"Calculation Details"}),e.jsxs("p",{className:"text-sm text-gray-400",children:[s.name,": ",he(s.value,s.valueType)]})]})]}),e.jsx("button",{onClick:n,className:"p-2 hover:bg-slate-700 rounded-lg transition-colors",children:e.jsx(ze,{className:"w-5 h-5 text-gray-400"})})]}),s.formula&&e.jsxs("div",{className:"mb-4 p-3 bg-slate-900 rounded-lg border border-slate-700",children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1",children:"Formula"}),e.jsxs("div",{className:"font-mono text-white",children:[s.name," = ",s.formula]}),e.jsxs("div",{className:"font-mono text-gray-400 mt-1",children:["= ",he(s.value,s.valueType)]})]}),e.jsxs("div",{className:"bg-slate-900 rounded-lg border border-slate-700 p-3 max-h-96 overflow-y-auto",children:[e.jsx("div",{className:"text-xs text-gray-500 mb-2",children:"Breakdown"}),e.jsx(Rt,{node:s,depth:0,onShowCode:x})]}),e.jsxs("div",{className:"mt-4 flex flex-wrap gap-4 text-xs",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(ne,{className:"w-3.5 h-3.5 text-purple-400"}),e.jsx("span",{className:"text-gray-400",children:"Definition"})]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(pt,{className:"w-3.5 h-3.5 text-emerald-400"}),e.jsx("span",{className:"text-gray-400",children:"Financial Data"})]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(gt,{className:"w-3.5 h-3.5 text-amber-400"}),e.jsx("span",{className:"text-gray-400",children:"Constant"})]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(Vt,{className:"w-3.5 h-3.5 text-gray-400"}),e.jsx("span",{className:"text-gray-400",children:"View Code"})]})]})]})}),e.jsx(At,{isOpen:l,onClose:()=>i(!1),elementType:"definition",elementName:c.name,code:c.code})]})}function Is({value:t,valueType:n,calculationNode:s,className:r="",children:l}){const[i,c]=g.useState(!1);return s?e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>c(!0),className:`cursor-pointer hover:underline hover:text-blue-400 transition-colors ${r}`,title:"Click to see calculation",children:l??he(t,n)}),e.jsx(Rs,{isOpen:i,onClose:()=>c(!1),rootNode:s,title:`How ${s.name} is calculated`})]}):e.jsx("span",{className:r,children:l??he(t,n)})}const at={breach:0,danger:1,caution:2,safe:3,suspended:4};function rt(t){return t.suspended?"suspended":t.compliant?ce(t.actual,t.required,t.operator):"breach"}function Fs({covenants:t,showNarratives:n=!0,showCodeButtons:s=!0,onRequestCure:r,onRequestWaiver:l,onRequestAmendment:i}){const{getCalculationTree:c}=te(),d=g.useMemo(()=>[...t].sort((h,p)=>{const u=rt(h),j=rt(p),N=at[u],E=at[j];if(N!==E)return N-E;const D=_e(h.actual,h.required,h.operator),y=_e(p.actual,p.required,p.operator);return D.percent-y.percent}),[t]),x=d.filter(h=>!h.suspended),a=d.filter(h=>h.suspended),o=x.reduce((h,p)=>{const u=p.compliant?ce(p.actual,p.required,p.operator):"breach";return h[u]=(h[u]||0)+1,h},{}),m=(o.caution||0)+(o.danger||0);return e.jsxs(U,{children:[e.jsx(q,{title:"Covenant Compliance",subtitle:e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsxs("span",{children:[x.filter(h=>h.compliant).length,"/",x.length," passing"]}),m>0&&e.jsxs("span",{className:"text-amber-400 text-xs",children:["(",m," approaching threshold)"]})]})}),e.jsxs(B,{className:"p-0",children:[e.jsx("div",{className:"divide-y divide-industry-borderDefault",children:x.map(h=>e.jsx(nt,{covenant:h,showNarrative:n,showCodeButton:s,getCalculationTree:c,onRequestCure:r,onRequestWaiver:l,onRequestAmendment:i},h.name))}),a.length>0&&e.jsxs("div",{className:"border-t border-industry-borderStrong bg-industry-headerBg/30",children:[e.jsxs("div",{className:"px-5 py-3 flex items-center gap-2",children:[e.jsx(ft,{className:"w-4 h-4 text-industry-textMuted"}),e.jsxs("span",{className:"text-sm font-medium text-industry-textMuted",children:["Suspended During Construction (",a.length,")"]})]}),e.jsx("div",{className:"divide-y divide-industry-borderDefault/50",children:a.map(h=>e.jsx(nt,{covenant:h,showNarrative:n,showCodeButton:s},h.name))})]})]})]})}function nt({covenant:t,showNarrative:n=!0,showCodeButton:s=!0,getCalculationTree:r,onRequestCure:l,onRequestWaiver:i,onRequestAmendment:c}){const{name:d,actual:x,required:a,operator:o,compliant:m,headroom:h,suspended:p}=t,[u,j]=g.useState(!1),N=p?"safe":m?ce(x,a,o):"breach",E=Ye(N),D=_e(x,a,o);let y=0;o==="<="?y=Math.min(x/a*100,100):o===">="&&(y=Math.min(a/x*100,100));const b=d.replace(/([A-Z])/g," $1").trim(),w=$=>$>=100?$.toFixed(0):$>=10?$.toFixed(1):$.toFixed(2),v=p?ft:N==="breach"?Q:N==="danger"?se:N==="caution"?V:z,f=p?"text-text-muted":N==="breach"?"text-danger":N==="danger"?"text-orange-500":N==="caution"?"text-warning":"text-success",S=d.replace(/^(Max|Min)/,""),F=r?r(S):null,M=us({name:d,metric:S,operator:o,threshold:a,tested:"quarterly"});return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:`px-5 py-4 ${p?"opacity-60":""}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(v,{className:`w-5 h-5 ${f} ${E.pulseAnimation?"animate-pulse":""}`}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm font-medium text-industry-textPrimary",children:b}),s&&e.jsx(Dt,{onClick:()=>j(!0)}),p&&e.jsx(Z,{status:"suspended",label:"Suspended"}),!p&&N==="caution"&&e.jsx("span",{className:"text-xs text-warning font-medium",children:"80%+"}),!p&&N==="danger"&&e.jsx("span",{className:"text-xs text-orange-400 font-medium animate-pulse",children:"90%+"})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"flex items-baseline gap-2",children:[e.jsxs(Is,{value:x,valueType:"ratio",calculationNode:F,className:`text-lg font-semibold tabular-nums ${p?"text-industry-textMuted":N==="breach"?"text-danger":N==="danger"?"text-orange-400":N==="caution"?"text-warning":"text-industry-textPrimary"}`,children:[w(x),"x"]}),e.jsxs("span",{className:"text-sm text-industry-textMuted",children:[o," ",w(a),"x"]})]}),!p&&e.jsx("span",{className:`text-xs ${N==="breach"?"text-danger":N==="danger"?"text-orange-400":N==="caution"?"text-warning":"text-success"}`,title:h!==void 0?`Headroom: ${w(h)}x`:void 0,children:D.isInBreach?"In breach":`${D.percent.toFixed(0)}% to breach`})]})]}),e.jsxs("div",{className:"progress-bar relative",children:[!p&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"absolute top-0 bottom-0 w-px bg-warning/30",style:{left:"80%"},title:"Caution zone (80%)"}),e.jsx("div",{className:"absolute top-0 bottom-0 w-px bg-orange-500/30",style:{left:"90%"},title:"Danger zone (90%)"})]}),e.jsx("div",{className:`progress-bar-fill ${p?"bg-text-muted":E.progressColor} ${E.pulseAnimation?"animate-pulse":""}`,style:{width:`${y}%`}})]}),e.jsx("div",{className:"relative h-0",children:e.jsx("div",{className:"absolute -top-2 w-0.5 h-4 bg-text-tertiary",style:{left:o==="<="?"100%":"0%"}})}),t.originalThreshold!==void 0&&e.jsxs("div",{className:"mt-2 flex items-center gap-2 text-xs text-industry-textMuted",children:[e.jsx(Ve,{className:"w-3.5 h-3.5 text-gold-400"}),e.jsxs("span",{children:["Step-down from ",w(t.originalThreshold),"x",t.activeStep&&e.jsxs(e.Fragment,{children:[" → ",e.jsxs("span",{className:"text-gold-400 font-medium",children:[w(t.activeStep.threshold),"x"]})," (since ",t.activeStep.afterDate,")"]}),t.nextStep&&e.jsxs(e.Fragment,{children:[" · next: ",w(t.nextStep.threshold),"x after ",t.nextStep.afterDate]})]})]}),n&&e.jsx("div",{className:"mt-3",children:e.jsx($s,{name:d,actual:x,threshold:a,operator:o,compliant:m,headroom:h,suspended:p,className:"opacity-80"})}),!p&&(N==="breach"||N==="danger")&&(l||i||c)&&e.jsxs("div",{className:"mt-3 flex items-center gap-2",children:[l&&e.jsx("button",{onClick:()=>l(t),className:"text-xs px-2.5 py-1 rounded-md bg-emerald-500/10 text-emerald-400 hover:bg-emerald-500/20 transition-colors",children:"Cure"}),i&&e.jsx("button",{onClick:()=>i(t),className:"text-xs px-2.5 py-1 rounded-md bg-amber-500/10 text-amber-400 hover:bg-amber-500/20 transition-colors",children:"Request Waiver"}),c&&e.jsx("button",{onClick:()=>c(t),className:"text-xs px-2.5 py-1 rounded-md bg-blue-500/10 text-blue-400 hover:bg-blue-500/20 transition-colors",children:"Draft Amendment"})]})]}),e.jsx(At,{isOpen:u,onClose:()=>j(!1),elementType:"covenant",elementName:d,code:M})]})}function ks({waterfall:t}){const{revenue:n,tiers:s}=t,{chartColors:r}=xt(),l=s.filter(a=>!a.blocked).reduce((a,o)=>a+o.amount,0),i=s.filter(a=>a.blocked).reduce((a,o)=>a+o.amount,0),c=n-l-i,d=(a,o)=>o?"#4b5563":r[a%r.length],x=({active:a,payload:o})=>{if(!a||!o||!o[0])return null;const m=o[0].payload;return e.jsxs("div",{className:"bg-industry-cardBg border border-industry-borderDefault rounded-lg px-3 py-2 shadow-lg",children:[e.jsx("p",{className:"text-sm font-medium text-industry-textPrimary",children:m.name}),e.jsxs("p",{className:"text-sm text-industry-textSecondary",children:["$",(m.amount/1e6).toFixed(2),"M"]}),m.blocked&&e.jsx("p",{className:"text-xs text-warning mt-1",children:m.reason})]})};return e.jsxs(U,{children:[e.jsx(q,{title:"Cash Flow Waterfall",subtitle:"Monthly distribution priority",action:e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-sm text-industry-textSecondary",children:"Revenue"}),e.jsxs("p",{className:"text-lg font-semibold text-industry-textPrimary",children:["$",(n/1e6).toFixed(1),"M"]})]})}),e.jsxs(B,{children:[e.jsx("div",{className:"h-24 mb-6",children:e.jsx(fe,{width:"100%",height:"100%",children:e.jsxs(Ct,{layout:"vertical",data:[{name:"Distribution",...Object.fromEntries(s.map((a,o)=>[`tier${o}`,a.amount]))}],margin:{top:0,right:0,left:0,bottom:0},children:[e.jsx(Se,{type:"number",hide:!0,domain:[0,n]}),e.jsx(Ae,{type:"category",hide:!0,dataKey:"name"}),e.jsx(De,{content:e.jsx(x,{})}),s.map((a,o)=>e.jsx(Et,{dataKey:`tier${o}`,stackId:"a",fill:d(o,!!a.blocked),radius:o===0?[4,0,0,4]:o===s.length-1?[0,4,4,0]:0,children:a.blocked&&e.jsx(Tt,{fill:"#4b5563",stroke:"#f59e0b",strokeWidth:2,strokeDasharray:"4 2"},`cell-${o}`)},o))]})})}),e.jsx("div",{className:"space-y-2",children:s.map((a,o)=>e.jsxs("div",{className:`flex items-center justify-between py-2 px-3 rounded-lg ${a.blocked?"bg-warning/5 border border-warning/20":"hover:bg-surface-2/50"}`,children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-3 h-3 rounded-sm",style:{backgroundColor:d(o,!!a.blocked)}}),e.jsx("span",{className:`text-sm ${a.blocked?"text-industry-textMuted":"text-industry-textSecondary"}`,children:a.name}),a.blocked&&e.jsxs("span",{className:"flex items-center gap-1 text-xs text-warning",children:[e.jsx(Gt,{className:"w-3 h-3"}),a.reason]})]}),e.jsxs("span",{className:`text-sm font-medium tabular-nums ${a.blocked?"text-industry-textMuted":"text-industry-textPrimary"}`,children:["$",(a.amount/1e6).toFixed(2),"M"]})]},o))}),e.jsxs("div",{className:"mt-4 pt-4 border-t border-industry-borderDefault grid grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-industry-textMuted",children:"Distributed"}),e.jsxs("p",{className:"text-lg font-semibold text-success",children:["$",(l/1e6).toFixed(2),"M"]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-industry-textMuted",children:"Blocked"}),e.jsxs("p",{className:"text-lg font-semibold text-warning",children:["$",(i/1e6).toFixed(2),"M"]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-industry-textMuted",children:"Remainder"}),e.jsxs("p",{className:"text-lg font-semibold text-industry-textPrimary",children:["$",(c/1e6).toFixed(2),"M"]})]})]}),i>0&&(()=>{const a=s.filter(m=>m.blocked&&m.reason).map(m=>m.reason),o=a.length>0?a.join("; "):"One or more distribution tiers are gated by unmet conditions";return e.jsxs("div",{className:"mt-4 flex items-start gap-2 p-3 rounded-lg bg-warning/5 border border-warning/20",children:[e.jsx(V,{className:"w-4 h-4 text-warning mt-0.5 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-warning font-medium",children:"Distribution Gate Active"}),e.jsx("p",{className:"text-xs text-text-tertiary mt-0.5",children:o})]})]})})()]})]})}function Ls({reserves:t}){return e.jsxs(U,{children:[e.jsx(q,{title:"Reserve Accounts",subtitle:`${t.length} active reserves`}),e.jsx(B,{className:"space-y-4",children:t.map(n=>e.jsx(Ms,{reserve:n},n.name))})]})}function Ms({reserve:t}){const{name:n,balance:s,target:r,minimum:l}=t,i=s/r*100,c=l/r*100,d=Math.min(i,100),x=s<l,a=s>=r,o=h=>h>=1e6?`$${(h/1e6).toFixed(1)}M`:h>=1e3?`$${(h/1e3).toFixed(0)}K`:`$${h.toFixed(0)}`,m=n.replace(/([A-Z])/g," $1").trim();return e.jsxs("div",{className:"p-4 rounded-lg bg-surface-1 border border-border-DEFAULT",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:`p-2 rounded-lg ${x?"bg-danger/10":a?"bg-success/10":"bg-gold-500/10"}`,children:e.jsx(qt,{className:`w-5 h-5 ${x?"text-danger":a?"text-success":"text-gold-500"}`})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-text-primary",children:m}),e.jsx("p",{className:"text-xs text-text-muted",children:x?"Below minimum":a?"Fully funded":"Funding in progress"})]})]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[x?e.jsx(se,{className:"w-4 h-4 text-danger"}):a?e.jsx(z,{className:"w-4 h-4 text-success"}):null,e.jsxs("span",{className:`text-lg font-semibold tabular-nums ${x?"text-danger":a?"text-success":"text-text-primary"}`,children:[i.toFixed(0),"%"]})]})]}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"h-3 bg-surface-3 rounded-full overflow-hidden",children:e.jsx("div",{className:`h-full rounded-full transition-all duration-500 ${x?"bg-gradient-to-r from-red-600 to-danger":a?"bg-gradient-to-r from-emerald-600 to-success":"bg-gradient-to-r from-gold-600 to-gold-500"}`,style:{width:`${d}%`}})}),e.jsx("div",{className:"absolute top-0 bottom-0 w-0.5 bg-warning",style:{left:`${c}%`},children:e.jsx("div",{className:"absolute -top-5 left-1/2 -translate-x-1/2 whitespace-nowrap",children:e.jsx("span",{className:"text-[10px] text-warning font-medium",children:"MIN"})})}),e.jsx("div",{className:"absolute top-0 bottom-0 right-0 w-0.5 bg-text-muted",children:e.jsx("div",{className:"absolute -top-5 left-1/2 -translate-x-1/2 whitespace-nowrap",children:e.jsx("span",{className:"text-[10px] text-text-muted font-medium",children:"TARGET"})})})]}),e.jsxs("div",{className:"flex items-center justify-between mt-4 text-xs",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-text-muted",children:"Balance:"}),e.jsx("span",{className:"text-text-primary font-medium",children:o(s)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-text-muted",children:"Min:"}),e.jsx("span",{className:"text-warning font-medium",children:o(l)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-text-muted",children:"Target:"}),e.jsx("span",{className:"text-text-tertiary font-medium",children:o(r)})]})]}),s>l&&e.jsx("div",{className:"mt-3 pt-3 border-t border-border-DEFAULT/50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-xs text-text-muted",children:"Available for Release"}),e.jsx("span",{className:"text-sm font-medium text-success",children:o(s-l)})]})})]})}function Ps({milestones:t}){const n=t.filter(r=>r.status==="achieved").length,s=t.filter(r=>r.status==="at_risk"||r.status==="breached").length;return e.jsxs(U,{children:[e.jsx(q,{title:"Construction Milestones",subtitle:`${n}/${t.length} completed`,action:s>0&&e.jsx(Z,{status:"warning",label:`${s} at risk`})}),e.jsx(B,{className:"p-0",children:e.jsx("div",{className:"divide-y divide-border-DEFAULT",children:t.map((r,l)=>e.jsx(Os,{milestone:r,isLast:l===t.length-1},r.name))})})]})}function Os({milestone:t}){const{name:n,target:s,longstop:r,status:l,achievedDate:i,percentComplete:c}=t,d=()=>{switch(l){case"achieved":return e.jsx(z,{className:"w-5 h-5 text-success"});case"in_progress":return e.jsx(ee,{className:"w-5 h-5 text-gold-500 animate-pulse"});case"at_risk":return e.jsx(V,{className:"w-5 h-5 text-warning"});case"breached":return e.jsx(Q,{className:"w-5 h-5 text-danger"});default:return e.jsx(ht,{className:"w-5 h-5 text-text-muted"})}},x=()=>{switch(l){case"achieved":return e.jsx(Z,{status:"achieved",label:"Achieved"});case"in_progress":return e.jsx(Z,{status:"pending",label:"In Progress"});case"at_risk":return e.jsx(Z,{status:"warning",label:"At Risk"});case"breached":return e.jsx(Z,{status:"breach",label:"Breached"});default:return e.jsx(Z,{status:"pending",label:"Pending"})}},a=u=>new Date(u).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}),o=u=>{const j=new Date(u),N=new Date,E=j.getTime()-N.getTime();return Math.ceil(E/(1e3*60*60*24))},m=o(s),h=o(r),p=n.replace(/([A-Z])/g," $1").trim();return e.jsx("div",{className:"px-5 py-4",children:e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx("div",{className:"mt-0.5",children:d()}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium text-text-primary",children:p}),l==="achieved"&&i&&e.jsxs("p",{className:"text-xs text-success mt-0.5",children:["Completed ",a(i)]})]}),x()]}),l==="in_progress"&&c!==void 0&&e.jsxs("div",{className:"mt-3",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("span",{className:"text-xs text-text-muted",children:"Progress"}),e.jsxs("span",{className:"text-xs font-medium text-gold-500",children:[c,"%"]})]}),e.jsx("div",{className:"progress-bar",children:e.jsx("div",{className:"progress-bar-fill bg-gradient-to-r from-gold-600 to-gold-400",style:{width:`${c}%`}})})]}),l!=="achieved"&&e.jsxs("div",{className:"flex items-center gap-4 mt-2 text-xs",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Target: "}),e.jsxs("span",{className:`font-medium ${m<0?"text-warning":m<14?"text-warning/80":"text-text-secondary"}`,children:[a(s),e.jsxs("span",{className:"text-text-muted ml-1",children:["(",m>0?`${m}d`:`${Math.abs(m)}d past`,")"]})]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Longstop: "}),e.jsx("span",{className:`font-medium ${h<0?"text-danger":h<30?"text-warning/80":"text-text-tertiary"}`,children:a(r)})]})]})]})]})})}function _s({checklists:t}){return e.jsxs(U,{children:[e.jsx(q,{title:"Conditions Precedent",subtitle:"Draw eligibility checklists"}),e.jsx(B,{className:"p-0 space-y-0 divide-y divide-border-DEFAULT",children:t.map(n=>e.jsx(Us,{checklist:n},n.name))})]})}function Us({checklist:t}){const{name:n,section:s,conditions:r}=t,l=r.filter(x=>x.status==="satisfied").length,i=r.filter(x=>x.status==="pending").length,c=r.filter(x=>x.status==="waived").length,d=i===0;return e.jsxs("div",{className:"p-5",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`p-2 rounded-lg ${d?"bg-success/10":"bg-warning/10"}`,children:e.jsx(Wt,{className:`w-5 h-5 ${d?"text-success":"text-warning"}`})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium text-text-primary",children:n}),s&&e.jsxs("p",{className:"text-xs text-text-muted",children:["Section ",s]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"text-right",children:[e.jsxs("p",{className:"text-sm font-semibold text-text-primary",children:[l,"/",r.length]}),e.jsx("p",{className:"text-xs text-text-muted",children:c>0&&`${c} waived`})]}),e.jsx(Z,{status:d?"compliant":"pending",label:d?"Ready":`${i} pending`})]})]}),e.jsx("div",{className:"progress-bar mb-4",children:e.jsx("div",{className:`progress-bar-fill ${d?"bg-gradient-to-r from-emerald-600 to-success":"bg-gradient-to-r from-gold-600 to-gold-500"}`,style:{width:`${l/r.length*100}%`}})}),e.jsx("div",{className:"space-y-2",children:r.map(x=>e.jsx(Bs,{item:x},x.name))})]})}function Bs({item:t}){const{name:n,description:s,responsible:r,status:l}=t,i=()=>{switch(l){case"satisfied":return e.jsx(z,{className:"w-4 h-4 text-success"});case"pending":return e.jsx(ee,{className:"w-4 h-4 text-warning"});case"waived":return e.jsx(Ht,{className:"w-4 h-4 text-text-muted"});case"not_applicable":return e.jsx(Q,{className:"w-4 h-4 text-text-muted"})}},c=()=>{switch(l){case"satisfied":return"text-success";case"pending":return"text-warning";default:return"text-text-muted"}};return e.jsxs("div",{className:`flex items-start gap-3 p-2 rounded-lg ${l==="pending"?"bg-warning/5":""}`,children:[e.jsx("div",{className:"mt-0.5",children:i()}),e.jsx("div",{className:"flex-1 min-w-0",children:e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{children:[e.jsx("p",{className:`text-sm ${l==="satisfied"?"text-text-tertiary line-through":l==="pending"?"text-text-primary":"text-text-muted"}`,children:n}),s&&l==="pending"&&e.jsx("p",{className:"text-xs text-text-muted mt-0.5",children:s})]}),r&&e.jsx("span",{className:`text-xs whitespace-nowrap ${c()}`,children:r})]})})]})}function zs({covenantName:t,data:n,operator:s,className:r=""}){var p,u,j;const l=((p=n[0])==null?void 0:p.threshold)??0,i=((u=n[n.length-1])==null?void 0:u.actual)??0,c=((j=n[n.length-1])==null?void 0:j.compliant)??!0,d=s==="<="||s==="<",x=n.flatMap(N=>[N.actual,N.threshold]),a=Math.min(...x)*.8,o=Math.max(...x)*1.2,m=n.length>=2?n[n.length-1].actual-n[n.length-2].actual:0,h=d?m<0?"improving":m>0?"worsening":"stable":m>0?"improving":m<0?"worsening":"stable";return e.jsxs("div",{className:`bg-slate-800 rounded-lg border border-slate-700 p-6 ${r}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-teal-500/10 rounded-lg",children:e.jsx(ie,{className:"h-5 w-5 text-teal-500"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-white",children:t}),e.jsxs("p",{className:"text-sm text-slate-400",children:["Threshold: ",s," ",l.toFixed(2),"x"]})]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-sm text-slate-400",children:"Current"}),e.jsxs("div",{className:`text-xl font-bold ${c?"text-green-400":"text-red-400"}`,children:[i.toFixed(2),"x"]})]}),c?e.jsx(Ge,{className:"h-8 w-8 text-green-400"}):e.jsx(Q,{className:"h-8 w-8 text-red-400"})]})]}),e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx("span",{className:`text-sm px-2 py-1 rounded ${h==="improving"?"bg-green-500/10 text-green-400":h==="worsening"?"bg-red-500/10 text-red-400":"bg-slate-700 text-slate-400"}`,children:h==="improving"?"↑ Improving":h==="worsening"?"↓ Worsening":"→ Stable"}),e.jsx("span",{className:"text-sm text-slate-400",children:"over last period"})]}),e.jsx("div",{className:"h-64",children:e.jsx(fe,{width:"100%",height:"100%",children:e.jsxs(yt,{data:n,margin:{top:10,right:30,left:0,bottom:0},children:[e.jsx(St,{strokeDasharray:"3 3",stroke:"#334155"}),e.jsx(Se,{dataKey:"period",tick:{fill:"#94a3b8",fontSize:12},axisLine:{stroke:"#475569"}}),e.jsx(Ae,{domain:[a,o],tick:{fill:"#94a3b8",fontSize:12},axisLine:{stroke:"#475569"},tickFormatter:N=>`${N.toFixed(1)}x`}),e.jsx(De,{contentStyle:{backgroundColor:"#1e293b",border:"1px solid #475569",borderRadius:"8px"},labelStyle:{color:"#f8fafc"},formatter:(N,E)=>[`${N.toFixed(2)}x`,E==="actual"?"Actual":"Threshold"]}),e.jsx(os,{wrapperStyle:{color:"#94a3b8"},formatter:N=>N==="actual"?"Actual":"Threshold"}),e.jsx(He,{y:l,stroke:"#f59e0b",strokeDasharray:"5 5",strokeWidth:2,label:{value:"Threshold",position:"right",fill:"#f59e0b",fontSize:12}}),e.jsx(wt,{type:"monotone",dataKey:"actual",stroke:"#14b8a6",strokeWidth:2,dot:N=>{const{cx:E,cy:D,payload:y}=N;return e.jsx("circle",{cx:E,cy:D,r:6,fill:y.compliant?"#22c55e":"#ef4444",stroke:"#1e293b",strokeWidth:2},y.period)},activeDot:{r:8,fill:"#14b8a6",stroke:"#0d9488"}})]})})}),e.jsxs("div",{className:"mt-4 flex items-center justify-between text-sm",children:[e.jsxs("div",{className:"text-slate-400",children:[n.filter(N=>N.compliant).length," of ",n.length," periods compliant"]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"w-3 h-3 rounded-full bg-green-400"}),e.jsx("span",{className:"text-slate-400",children:"Compliant"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"w-3 h-3 rounded-full bg-red-400"}),e.jsx("span",{className:"text-slate-400",children:"Breach"})]})]})]})]})}function Vs(t,n,s){const{actual:r,required:l,operator:i}=t,c=l,d=[],x=Math.abs(c-r)*.3,a=(Math.random()-.5)*x*2;for(let o=0;o<n;o++){const m=o/(n-1),h=r+a,p=h+(r-h)*m,u=(Math.random()-.5)*x*.5,j=p+u*(1-m*.7),N=Math.round(j*100)/100;let E;switch(i){case"<=":E=N<=c;break;case">=":E=N>=c;break;case"<":E=N<c;break;case">":E=N>c;break;case"=":E=Math.abs(N-c)<.01;break;default:E=N<=c}d.push({period:s[o]||`P${o+1}`,actual:N,threshold:c,compliant:E})}return d.length>0&&(d[d.length-1]={period:s[n-1]||`P${n}`,actual:r,threshold:c,compliant:t.compliant}),d}function Gs(t){const n=new Date().getFullYear(),s=Math.ceil((new Date().getMonth()+1)/3),r=[];let l=n,i=s;for(let c=t-1;c>=0;c--)r[c]=`Q${i} ${l}`,i--,i<1&&(i=4,l--);return r}function qs({covenantName:t,periods:n=6,periodLabels:s,className:r=""}){var h;const{covenants:l,isLoaded:i,isMultiPeriod:c,complianceHistory:d}=te(),x=g.useMemo(()=>l.find(p=>p.name===t),[l,t]),a=g.useMemo(()=>s||Gs(n),[s,n]),o=g.useMemo(()=>{var p;return x?c&&((p=d[t])==null?void 0:p.length)>1?d[t]:Vs(x,n,a):[]},[x,n,a,c,d,t]);if(!i)return e.jsx("div",{className:`bg-slate-800 rounded-lg border border-slate-700 p-6 ${r}`,children:e.jsx("div",{className:"text-center text-slate-400 py-8",children:"Loading covenant data..."})});if(!x)return e.jsx("div",{className:`bg-slate-800 rounded-lg border border-slate-700 p-6 ${r}`,children:e.jsxs("div",{className:"text-center text-slate-400 py-8",children:['Covenant "',t,'" not found']})});const m=c&&(((h=d[t])==null?void 0:h.length)??0)>1;return e.jsxs("div",{className:r,children:[e.jsx(zs,{covenantName:t,data:o,operator:x.operator}),e.jsx("div",{className:"text-xs text-text-muted mt-1 px-2",children:m?`${o.length} periods of actual compliance data`:"Simulated trend — upload multi-period financials for real history"})]})}function Ws({covenantNames:t,periods:n=6,className:s=""}){const{covenants:r,isLoaded:l}=te(),i=g.useMemo(()=>t&&t.length>0?t:r.filter(c=>!c.suspended).slice(0,2).map(c=>c.name),[t,r]);return l?i.length===0?e.jsx("div",{className:`bg-slate-800 rounded-lg border border-slate-700 p-6 ${s}`,children:e.jsx("div",{className:"text-center text-slate-400 py-8",children:"No covenants available for trend display"})}):e.jsx("div",{className:`grid grid-cols-1 lg:grid-cols-2 gap-6 ${s}`,children:i.map(c=>e.jsx(qs,{covenantName:c,periods:n},c))}):e.jsx("div",{className:`space-y-6 ${s}`,children:e.jsx("div",{className:"bg-slate-800 rounded-lg border border-slate-700 p-6 h-80 animate-pulse"})})}const Hs=t=>Math.abs(t)>=1e9?`$${(t/1e9).toFixed(1)}B`:Math.abs(t)>=1e6?`$${(t/1e6).toFixed(1)}M`:Math.abs(t)>=1e3?`$${(t/1e3).toFixed(1)}K`:`$${t.toFixed(0)}`,Ys=[{value:"percentage",label:"%"},{value:"absolute",label:"$"}];function Qs({fields:t,calculateCovenants:n,className:s=""}){var y;const[r,l]=g.useState([{field:((y=t[0])==null?void 0:y.key)??"",type:"percentage",value:""}]),[i,c]=g.useState(!1),d=g.useMemo(()=>{const b={};for(const w of t)b[w.key]=w.currentValue;return b},[t]),x=g.useMemo(()=>{const b={...d};for(const w of r){if(!w.field||!w.value||w.value.trim()==="")continue;const v=parseFloat(w.value);if(isNaN(v))continue;const f=b[w.field]??0;w.type==="percentage"?b[w.field]=f*(1+v/100):b[w.field]=f+v}return b},[d,r]),a=g.useMemo(()=>n(d),[n,d]),o=g.useMemo(()=>n(x),[n,x]),m=g.useMemo(()=>a.map(b=>{const w=o.find(F=>F.name===b.name);if(!w)return null;const v=w.actual-b.actual,f=b.actual!==0?v/b.actual*100:0;let S;return Math.abs(v)<.001?S="unchanged":w.headroom>b.headroom?S="improved":S="worsened",{name:b.name,baselineActual:b.actual,scenarioActual:w.actual,baselineCompliant:b.compliant,scenarioCompliant:w.compliant,change:v,changePercent:f,impactType:S,threshold:b.threshold}}).filter(Boolean),[a,o]),h=o.every(b=>b.compliant),p=()=>{l([...r,{field:"",type:"percentage",value:""}])},u=b=>{l(r.filter((w,v)=>v!==b))},j=(b,w,v)=>{const f=[...r];f[b]={...f[b],[w]:v.target.value},l(f)},N=()=>{var b;l([{field:((b=t[0])==null?void 0:b.key)??"",type:"percentage",value:""}]),c(!1)},E=()=>{ps(),c(!0)},D=t.map(b=>({value:b.key,label:b.label}));return e.jsxs("div",{className:`bg-slate-800 rounded-lg border border-slate-700 ${s}`,children:[e.jsx("div",{className:"p-6 border-b border-slate-700",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-purple-500/10 rounded-lg",children:e.jsx(ne,{className:"h-5 w-5 text-purple-400"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-white",children:"Scenario Simulator"}),e.jsx("p",{className:"text-sm text-slate-400",children:'Test "what if" scenarios on covenant compliance'})]})]})}),e.jsxs("div",{className:"p-6 border-b border-slate-700",children:[e.jsx("h4",{className:"text-sm font-medium text-slate-400 mb-4",children:"Adjustments"}),e.jsx("div",{className:"space-y-3",children:r.map((b,w)=>e.jsxs("div",{className:"flex items-end gap-3",children:[e.jsx("div",{className:"flex-1",children:e.jsx(X,{label:w===0?"Field":void 0,options:D,value:b.field,onChange:v=>j(w,"field",v),placeholder:"Select field..."})}),e.jsx("div",{className:"w-24",children:e.jsx(X,{label:w===0?"Type":void 0,options:Ys,value:b.type,onChange:v=>j(w,"type",v)})}),e.jsx("div",{className:"w-32",children:e.jsx(J,{label:w===0?"Change":void 0,value:b.value,onChange:v=>j(w,"value",v),placeholder:b.type==="percentage"?"+10":"+1M"})}),r.length>1&&e.jsx("button",{onClick:()=>u(w),className:"p-2 text-slate-400 hover:text-red-400 transition-colors",children:"×"})]},w))}),e.jsx("div",{className:"mt-4 flex items-center gap-3",children:e.jsx("button",{onClick:p,className:"text-sm text-teal-400 hover:text-teal-300 transition-colors",children:"+ Add adjustment"})}),e.jsxs("div",{className:"mt-6 flex items-center gap-3",children:[e.jsxs(I,{variant:"gold",onClick:E,children:[e.jsx(ne,{className:"h-4 w-4 mr-2"}),"Run Scenario"]}),e.jsx(I,{variant:"ghost",onClick:N,children:"Reset"})]})]}),i&&e.jsxs("div",{className:"p-6",children:[e.jsx("div",{className:`mb-6 p-4 rounded-lg ${h?"bg-green-500/10 border border-green-500/20":"bg-red-500/10 border border-red-500/20"}`,children:e.jsxs("div",{className:"flex items-center gap-3",children:[h?e.jsx(Ge,{className:"h-6 w-6 text-green-400"}):e.jsx(V,{className:"h-6 w-6 text-red-400"}),e.jsxs("div",{children:[e.jsx("div",{className:`font-semibold ${h?"text-green-400":"text-red-400"}`,children:h?"All Covenants Pass":"Covenant Breach Detected"}),e.jsxs("div",{className:"text-sm text-slate-400",children:[o.filter(b=>b.compliant).length," of ",o.length," covenants compliant under this scenario"]})]})]})}),e.jsx("h4",{className:"text-sm font-medium text-slate-400 mb-3",children:"Adjusted Financials"}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 mb-6",children:t.map(b=>{const w=d[b.key]??0,v=x[b.key]??0,f=v-w,S=w!==0?f/w*100:0;return e.jsxs("div",{className:"bg-slate-700/50 rounded-lg p-3",children:[e.jsx("div",{className:"text-xs text-slate-400 mb-1",children:b.label}),e.jsx("div",{className:"text-white font-medium",children:Hs(v)}),f!==0&&e.jsxs("div",{className:`text-xs ${f>0?"text-green-400":"text-red-400"}`,children:[f>0?"+":"",S.toFixed(1),"%"]})]},b.key)})}),e.jsx("h4",{className:"text-sm font-medium text-slate-400 mb-3",children:"Covenant Impact"}),e.jsx("div",{className:"space-y-3",children:m.map(b=>b?e.jsx("div",{className:`p-4 rounded-lg border ${b.scenarioCompliant?"bg-slate-700/30 border-slate-600":"bg-red-500/10 border-red-500/20"}`,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[b.impactType==="improved"?e.jsx(ie,{className:"h-4 w-4 text-green-400"}):b.impactType==="worsened"?e.jsx(Ve,{className:"h-4 w-4 text-red-400"}):e.jsx(Yt,{className:"h-4 w-4 text-slate-400"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-white font-medium",children:b.name}),e.jsxs("div",{className:"text-sm text-slate-400",children:["Threshold: ",b.threshold.toFixed(2),"x"]})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"text-slate-400",children:[b.baselineActual.toFixed(2),"x"]}),e.jsx("span",{className:"text-slate-500",children:"→"}),e.jsxs("div",{className:b.scenarioCompliant?"text-green-400":"text-red-400",children:[b.scenarioActual.toFixed(2),"x"]})]}),e.jsxs("div",{className:`text-sm ${b.impactType==="improved"?"text-green-400":b.impactType==="worsened"?"text-red-400":"text-slate-400"}`,children:[b.change>0?"+":"",b.changePercent.toFixed(1),"%"]})]})]})},b.name):null)})]})]})}function Ks(t){const n={net_income:"Net Income",interest_expense:"Interest Expense",tax_expense:"Tax Expense",depreciation:"Depreciation",amortization:"Amortization",senior_debt:"Senior Debt",subordinated_debt:"Subordinated Debt",senior_interest:"Senior Interest",senior_principal:"Senior Principal",total_project_cost:"Total Project Cost",equity_contributed:"Equity Contributed",monthly_debt_service:"Monthly Debt Service",annual_capex_budget:"Annual CapEx Budget",operating_expenses:"Operating Expenses",distributions:"Distributions",Revenue:"Revenue",total_assets:"Total Assets"};return n[t]?n[t]:t.replace(/_/g," ").replace(/\b\w/g,s=>s.toUpperCase())}function Zs({className:t=""}){const{financials:n,interpreter:s,isLoaded:r}=te(),l=g.useMemo(()=>!n||Object.keys(n).length===0?[]:Object.entries(n).filter(([c,d])=>typeof d=="number").map(([c,d])=>({key:c,label:Ks(c),currentValue:d})).sort((c,d)=>c.label.localeCompare(d.label)),[n]),i=g.useCallback(c=>{if(!s)return[];const d={...n};try{return s.loadFinancials(c),s.checkAllCovenants().map(a=>({name:a.name,actual:a.actual,threshold:a.threshold,compliant:a.compliant,headroom:a.headroom??0}))}finally{s.loadFinancials(d)}},[s,n]);return!r||l.length===0?e.jsx("div",{className:`bg-slate-800 rounded-lg border border-slate-700 p-6 ${t}`,children:e.jsx("div",{className:"text-center text-slate-400",children:e.jsx("p",{children:"Load financial data to use the Scenario Simulator"})})}):e.jsx(Qs,{fields:l,calculateCovenants:i,className:t})}function Y(t){return t>=1e9?`$${(t/1e9).toFixed(1)}B`:t>=1e6?`$${(t/1e6).toFixed(1)}M`:t>=1e3?`$${(t/1e3).toFixed(0)}K`:`$${t.toFixed(0)}`}function pe(t){return`${t.toFixed(2)}x`}function ge(t){return t.replace(/([A-Z])/g," $1").replace(/^[\s_]+|[\s_]+$/g,"").trim()}function Xs({isOpen:t,onClose:n,covenant:s,onCureApplied:r}){var w,v;const{interpreter:l}=te(),[i,c]=g.useState(null),[d,x]=g.useState(""),[a,o]=g.useState(null),[m,h]=g.useState(!1),p=g.useMemo(()=>{if(!l||!s)return[];try{if(!l.getCovenantsWithCure().includes(s.name))return[];const S=l.getCureUsage(),F=[],M=new Set;for(const $ of S){if(M.has($.mechanism))continue;M.add($.mechanism);const _=$.mechanism.toLowerCase().includes("equity");F.push({mechanism:$.mechanism,label:_?"Equity Cure":"Payment Cure",description:_?"Inject equity capital to cure the breach. Increases EBITDA base.":"Make a principal payment to cure the breach. Reduces outstanding debt.",maxAmount:null,usesRemaining:$.usesRemaining,maxUses:$.maxUses,period:$.period,available:$.usesRemaining>0})}return F}catch{return[]}},[l,s]),u=g.useMemo(()=>!s||s.compliant?0:s.operator==="<="||s.operator==="<"?s.actual-s.required:s.required-s.actual,[s]),j=g.useMemo(()=>s?s.actual>10?f=>Y(f):f=>pe(f):f=>f.toFixed(2),[s]),N=g.useMemo(()=>s?s.compliant?ce(s.actual,s.required,s.operator):"breach":"safe",[s]),E=Ye(N),D=()=>{if(!l||!s||!i)return;const f=parseFloat(d.replace(/[$,_]/g,""));if(isNaN(f)||f<=0){o({success:!1,reason:"Enter a valid cure amount"});return}u>0&&f<u&&s.actual<=100;try{if(!l.canApplyCure(s.name)){o({success:!1,reason:"No cure uses remaining for this covenant"});return}o({success:!0,curedAmount:f,costDescription:i.toLowerCase().includes("equity")?`Equity injection of ${Y(f)} required`:`Principal prepayment of ${Y(f)} required`})}catch(S){o({success:!1,reason:S.message})}},y=()=>{if(!l||!s||!i)return;const f=parseFloat(d.replace(/[$,_]/g,""));if(!(isNaN(f)||f<=0))try{const S=l.applyCure(s.name,f);S.success?(h(!0),r==null||r(s.name,i,f)):o({success:!1,reason:S.reason||"Cure application failed"})}catch(S){o({success:!1,reason:S.message})}},b=()=>{c(null),x(""),o(null),h(!1),n()};return s?e.jsx(le,{isOpen:t,onClose:b,title:"Cure Rights Optimizer",size:"lg",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:`rounded-lg border p-4 ${E.bgColor} ${E.borderColor}`,children:[e.jsxs("div",{className:"flex items-center gap-3 mb-3",children:[e.jsx(V,{className:`w-5 h-5 ${E.textColor}`}),e.jsxs("h3",{className:`font-semibold ${E.textColor}`,children:[ge(s.name)," — ",s.compliant?"At Risk":"In Breach"]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-text-muted uppercase tracking-wider mb-1",children:"Actual"}),e.jsx("p",{className:"text-lg font-mono font-semibold text-text-primary",children:j(s.actual)})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-text-muted uppercase tracking-wider mb-1",children:"Threshold"}),e.jsxs("p",{className:"text-lg font-mono font-semibold text-text-primary",children:[s.operator," ",j(s.required)]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-text-muted uppercase tracking-wider mb-1",children:"Shortfall"}),e.jsx("p",{className:`text-lg font-mono font-semibold ${u>0?"text-danger":"text-success"}`,children:u>0?j(u):"None"})]})]})]}),m&&e.jsx("div",{className:"rounded-lg border border-success/30 bg-success/10 p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(z,{className:"w-5 h-5 text-success"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-success",children:"Cure Applied Successfully"}),e.jsxs("p",{className:"text-sm text-text-tertiary mt-1",children:[i," of ",Y(parseFloat(d.replace(/[$,_]/g,"")))," applied to ",ge(s.name),". Refresh the dashboard to see updated compliance status."]})]})]})}),p.length===0&&!m&&e.jsxs("div",{className:"rounded-lg border border-border-DEFAULT bg-surface-1 p-6 text-center",children:[e.jsx(Q,{className:"w-8 h-8 text-text-muted mx-auto mb-3"}),e.jsx("p",{className:"text-text-primary font-medium mb-1",children:"No Cure Mechanisms Available"}),e.jsx("p",{className:"text-sm text-text-tertiary",children:"This covenant does not have cure rights defined. Consider requesting a waiver or negotiating an amendment."})]}),p.length>0&&!m&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-semibold text-text-primary mb-3",children:"Available Cure Mechanisms"}),e.jsx("div",{className:"space-y-3",children:p.map(f=>e.jsxs("button",{onClick:()=>c(f.mechanism),disabled:!f.available,className:`w-full text-left p-4 rounded-lg border transition-all ${i===f.mechanism?"border-gold-500/50 bg-gold-500/5 ring-1 ring-gold-500/20":f.available?"border-border-DEFAULT bg-surface-1 hover:bg-surface-2":"border-border-DEFAULT bg-surface-1 opacity-50 cursor-not-allowed"}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ke,{className:`w-4 h-4 ${i===f.mechanism?"text-gold-500":"text-text-muted"}`}),e.jsx("span",{className:"font-medium text-text-primary",children:f.label}),!f.available&&e.jsx(xe,{variant:"danger",size:"sm",children:"Exhausted"})]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-text-muted",children:[e.jsx(ee,{className:"w-3 h-3"}),e.jsxs("span",{children:[f.usesRemaining," of ",f.maxUses," uses remaining"]})]})]}),e.jsx("p",{className:"text-sm text-text-tertiary",children:f.description}),e.jsxs("div",{className:"flex items-center gap-4 mt-2 text-xs text-text-muted",children:[e.jsxs("span",{children:["Period: ",f.period.replace(/_/g," ")]}),f.maxAmount&&e.jsxs("span",{children:["Max: ",Y(f.maxAmount)]})]})]},f.mechanism))})]}),i&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-text-secondary mb-1",children:"Cure Amount ($)"}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(J,{value:d,onChange:f=>{x(f.target.value),o(null)},placeholder:"e.g., 5,000,000",className:"flex-1"}),e.jsx(I,{variant:"secondary",onClick:D,icon:e.jsx(jt,{className:"w-4 h-4"}),children:"Simulate"})]}),e.jsx("p",{className:"text-xs text-text-muted mt-1",children:"Enter the amount to cure. Must cover the covenant shortfall."})]}),a&&e.jsxs("div",{className:`rounded-lg border p-4 ${a.success?"border-success/30 bg-success/5":"border-danger/30 bg-danger/5"}`,children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[a.success?e.jsx(z,{className:"w-4 h-4 text-success"}):e.jsx(Q,{className:"w-4 h-4 text-danger"}),e.jsx("span",{className:`font-medium text-sm ${a.success?"text-success":"text-danger"}`,children:a.success?"Cure Feasible":"Cure Not Feasible"})]}),a.success&&a.costDescription&&e.jsxs("div",{className:"space-y-2 mt-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm text-text-secondary",children:[e.jsx(re,{className:"w-4 h-4 text-text-muted"}),e.jsx("span",{children:a.costDescription})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-text-secondary",children:[e.jsx(Te,{className:"w-4 h-4 text-text-muted"}),e.jsxs("span",{children:["Cure right will be consumed (",((w=p.find(f=>f.mechanism===i))==null?void 0:w.usesRemaining)??0," → ",(((v=p.find(f=>f.mechanism===i))==null?void 0:v.usesRemaining)??1)-1," remaining)"]})]})]}),a.reason&&e.jsx("p",{className:"text-sm text-danger mt-1",children:a.reason})]}),(a==null?void 0:a.success)&&e.jsxs("div",{className:"flex items-center justify-between pt-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-xs text-text-muted",children:[e.jsx(qe,{className:"w-3 h-3"}),e.jsx("span",{children:"This action cannot be undone"})]}),e.jsx(I,{variant:"gold",onClick:y,icon:e.jsx(Ke,{className:"w-4 h-4"}),children:"Apply Cure"})]})]})]})]})}):null}function Js(t,n,s,r,l,i){const c=t.operator==="<="||t.operator==="<",d=t.actual>10?u=>Y(u):u=>pe(u),x=Math.abs(t.actual-t.required),a=ge(t.name),o=i||"[Borrower]",m=l||"[Facility]",h=n==="temporary"?"temporary waiver":n==="amendment_pending"?"waiver pending amendment":"permanent waiver",p=[`Re: Request for ${h} — ${a}`,"","Dear Administrative Agent,","",`${o} ("Borrower") hereby requests a ${h} of the ${a} covenant under the ${m} (the "Credit Agreement").`,"",`As of the most recent testing date, the Borrower's ${a} stood at ${d(t.actual)}, which ${c?"exceeds":"falls below"} the required threshold of ${t.operator} ${d(t.required)} by ${d(x)}.`,""];return n==="temporary"?p.push(`The Borrower requests a temporary waiver for a period of ${r||"[duration]"}, during which the ${a} covenant testing shall be suspended.`,""):n==="amendment_pending"&&p.push(`The Borrower requests a waiver of the ${a} covenant pending execution of an amendment to the Credit Agreement that would ${c?"increase":"decrease"} the threshold to an appropriate level.`,""),p.push("The Borrower believes this breach is [temporary/due to specific circumstances] and expects to return to compliance within [timeframe]. The following remediation steps are being taken:","","1. [Describe remediation step 1]","2. [Describe remediation step 2]","","We respectfully request the Required Lenders' consent to this waiver at their earliest convenience.","","Respectfully,",`${o}`),p.join(`
`)}function ea({isOpen:t,onClose:n,covenant:s,allBreachedCovenants:r=[],onSubmit:l,dealName:i,borrowerName:c}){const[d,x]=g.useState("temporary"),[a,o]=g.useState("standard"),[m,h]=g.useState("90 days"),[p,u]=g.useState(""),[j,N]=g.useState(""),[E,D]=g.useState(""),[y,b]=g.useState(""),[w,v]=g.useState(!1),[f,S]=g.useState(!1),F=g.useMemo(()=>s?Js(s,d,a,m,i,c):"",[s,d,a,m,i,c]),M=g.useMemo(()=>!s||s.compliant?0:s.operator==="<="||s.operator==="<"?s.actual-s.required:s.required-s.actual,[s]),$=g.useMemo(()=>s?s.actual>10?R=>Y(R):R=>pe(R):R=>R.toFixed(2),[s]),_=g.useMemo(()=>s?s.compliant?ce(s.actual,s.required,s.operator):"breach":"safe",[s]),k=Ye(_),K=async()=>{await navigator.clipboard.writeText(F),v(!0),setTimeout(()=>v(!1),2e3)},oe=()=>{if(!s)return;const R={covenantName:s.name,waiverType:d,urgency:a,requestedDuration:m,justification:p,proposedRemediation:j,contactName:E,contactEmail:y};l==null||l(R),S(!0)},W=()=>{x("temporary"),o("standard"),h("90 days"),u(""),N(""),D(""),b(""),v(!1),S(!1),n()};return s?e.jsx(le,{isOpen:t,onClose:W,title:"Waiver Request Portal",size:"xl",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:`rounded-lg border p-4 ${k.bgColor} ${k.borderColor}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(V,{className:`w-5 h-5 ${k.textColor}`}),e.jsxs("h3",{className:`font-semibold ${k.textColor}`,children:[ge(s.name)," — Breach"]})]}),r.length>1&&e.jsxs(xe,{variant:"danger",size:"sm",children:[r.length," covenants in breach"]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-text-muted uppercase tracking-wider mb-1",children:"Actual"}),e.jsx("p",{className:"text-lg font-mono font-semibold text-text-primary",children:$(s.actual)})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-text-muted uppercase tracking-wider mb-1",children:"Threshold"}),e.jsxs("p",{className:"text-lg font-mono font-semibold text-text-primary",children:[s.operator," ",$(s.required)]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-text-muted uppercase tracking-wider mb-1",children:"Shortfall"}),e.jsx("p",{className:"text-lg font-mono font-semibold text-danger",children:$(M)})]})]})]}),f&&e.jsx("div",{className:"rounded-lg border border-success/30 bg-success/10 p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Ce,{className:"w-5 h-5 text-success"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-success",children:"Waiver Request Submitted"}),e.jsx("p",{className:"text-sm text-text-tertiary mt-1",children:"Your waiver request has been logged. In a production system, this would be routed to the Administrative Agent and Required Lenders for approval."})]})]})}),!f&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-text-secondary mb-1",children:"Waiver Type"}),e.jsx(X,{value:d,onChange:R=>x(R.target.value),options:[{value:"temporary",label:"Temporary Waiver"},{value:"permanent",label:"Permanent Waiver"},{value:"amendment_pending",label:"Waiver Pending Amendment"}]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-text-secondary mb-1",children:"Urgency"}),e.jsx(X,{value:a,onChange:R=>o(R.target.value),options:[{value:"standard",label:"Standard (30 days)"},{value:"expedited",label:"Expedited (10 days)"},{value:"emergency",label:"Emergency (48 hours)"}]})]})]}),d==="temporary"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-text-secondary mb-1",children:"Requested Duration"}),e.jsx(X,{value:m,onChange:R=>h(R.target.value),options:[{value:"30 days",label:"30 days"},{value:"60 days",label:"60 days"},{value:"90 days",label:"90 days"},{value:"one fiscal quarter",label:"One fiscal quarter"},{value:"two fiscal quarters",label:"Two fiscal quarters"}]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-text-secondary mb-1",children:"Justification / Business Context"}),e.jsx(Je,{value:p,onChange:R=>u(R.target.value),placeholder:"Describe the circumstances that led to the breach and why a waiver is appropriate...",rows:3})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-text-secondary mb-1",children:"Proposed Remediation"}),e.jsx(Je,{value:j,onChange:R=>N(R.target.value),placeholder:"Describe the steps being taken to return to compliance...",rows:3})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-text-secondary mb-1",children:"Contact Name"}),e.jsx(J,{value:E,onChange:R=>D(R.target.value),placeholder:"e.g., Jennifer Chen, CFO"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-text-secondary mb-1",children:"Contact Email"}),e.jsx(J,{value:y,onChange:R=>b(R.target.value),placeholder:"e.g., jchen@company.com"})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ue,{className:"w-4 h-4 text-text-muted"}),e.jsx("label",{className:"text-sm font-medium text-text-secondary",children:"Generated Waiver Request Letter"})]}),e.jsx(I,{variant:"ghost",size:"sm",icon:w?e.jsx(Ce,{className:"w-3 h-3 text-success"}):e.jsx(bt,{className:"w-3 h-3"}),onClick:K,children:w?"Copied":"Copy"})]}),e.jsx("div",{className:"rounded-lg border border-border-DEFAULT bg-surface-2 overflow-hidden",children:e.jsx("pre",{className:"p-4 text-sm text-text-secondary overflow-auto max-h-[200px] whitespace-pre-wrap font-serif leading-relaxed",children:F})}),e.jsxs("p",{className:"text-xs text-text-muted mt-1 flex items-center gap-1",children:[e.jsx(qe,{className:"w-3 h-3"}),"Auto-generated from covenant data. Edit the fields above to customize."]})]}),e.jsxs("div",{className:"flex items-center justify-between pt-2 border-t border-border-DEFAULT",children:[e.jsxs("div",{className:"flex items-center gap-2 text-xs text-text-muted",children:[e.jsx(Qt,{className:"w-3 h-3"}),e.jsx("span",{children:a==="emergency"?"Emergency: Notify agent within 48 hours":a==="expedited"?"Expedited: Target 10-day turnaround":"Standard: Target 30-day turnaround"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(I,{variant:"ghost",onClick:W,children:"Cancel"}),e.jsx(I,{variant:"gold",onClick:oe,icon:e.jsx(Kt,{className:"w-4 h-4"}),children:"Submit Request"})]})]})]})]})}):null}function ta(t,n,s){const r=new Date().toISOString().split("T")[0],l=[`AMENDMENT ${t}`,`  EFFECTIVE ${r}`,`  DESCRIPTION "${n}"`,""];for(const i of s)switch(i.type){case"MODIFIES":l.push(`  MODIFIES ${i.targetType} ${i.targetName}`),i.modifyField&&i.newValue&&l.push(`    ${i.modifyField} ${i.newValue}`),l.push("");break;case"REPLACES":if(l.push(`  REPLACES ${i.targetType} ${i.targetName} WITH`),i.replacementCode){const c=i.replacementCode.split(`
`);for(const d of c)l.push(`    ${d}`)}l.push("");break;case"ADDS":if(l.push("  ADDS"),i.replacementCode){const c=i.replacementCode.split(`
`);for(const d of c)l.push(`    ${d}`)}l.push("");break;case"DELETES":l.push(`  DELETES ${i.targetType} ${i.targetName}`),l.push("");break}return l.join(`
`)}function sa(t,n){let s=t;for(const r of n)switch(r.type){case"MODIFIES":{if(!r.modifyField||!r.newValue)break;const l=new RegExp(`(${r.targetType}\\s+${r.targetName}[\\s\\S]*?)${r.modifyField}\\s+[^\\n]+`,"i");s.match(l)&&(s=s.replace(l,`$1${r.modifyField} ${r.newValue}`));break}case"DELETES":{const l=new RegExp(`${r.targetType}\\s+${r.targetName}[\\s\\S]*?(?=\\n(?:COVENANT|BASKET|DEFINE|CONDITION|PROHIBIT|EVENT|PHASE|AMENDMENT|$))`,"i");s=s.replace(l,"");break}case"ADDS":{r.replacementCode&&(s=s.trimEnd()+`

`+r.replacementCode+`
`);break}case"REPLACES":{if(!r.replacementCode)break;const l=new RegExp(`${r.targetType}\\s+${r.targetName}[\\s\\S]*?(?=\\n(?:COVENANT|BASKET|DEFINE|CONDITION|PROHIBIT|EVENT|PHASE|AMENDMENT|$))`,"i");s=s.replace(l,r.replacementCode);break}}return s}let it=0;function aa({isOpen:t,onClose:n,currentCode:s,triggerCovenant:r,amendmentNumber:l=1,onGenerate:i}){const[c,d]=g.useState(""),[x,a]=g.useState([]),[o,m]=g.useState(null),[h,p]=g.useState(!1),[u,j]=g.useState(null),[N,E]=g.useState(!1),[D,y]=g.useState("MODIFIES"),[b,w]=g.useState("COVENANT"),[v,f]=g.useState(""),[S,F]=g.useState("REQUIRES"),[M,$]=g.useState("");g.useEffect(()=>{if(r&&t&&x.length===0){const O=r.operator==="<="||r.operator==="<"?r.required*1.1:r.required*.9,H=r.required>10?`$${Math.round(O).toLocaleString().replace(/,/g,"_")}`:O.toFixed(2);a([{id:`dir-${++it}`,type:"MODIFIES",targetType:"COVENANT",targetName:r.name,description:`Adjust threshold from ${r.operator} ${r.required>10?Y(r.required):pe(r.required)} to ${r.operator} ${r.required>10?Y(O):pe(O)}`,modifyField:"REQUIRES",newValue:`${r.name.replace(/^(Max|Min)/,"")} ${r.operator} ${H}`}]),d(`Adjust ${ge(r.name)} threshold following waiver`),f(r.name)}},[r,t]);const _=g.useMemo(()=>ta(l,c,x),[l,c,x]),k=g.useMemo(()=>sa(s,x),[s,x]),K=g.useCallback(async()=>{if(x.length===0||!s){m(null);return}p(!0),j(null);try{const C=await fs(s,k,0,l,"Amendment");m(C)}catch(C){j(C.message)}finally{p(!1)}},[s,k,x.length,l]);g.useEffect(()=>{if(t&&x.length>0){const C=setTimeout(K,500);return()=>clearTimeout(C)}},[t,K,x.length]);const oe=()=>{if(!v.trim())return;const C={id:`dir-${++it}`,type:D,targetType:b,targetName:v.trim(),description:""};D==="MODIFIES"?(C.modifyField=S,C.newValue=M):(D==="REPLACES"||D==="ADDS")&&(C.replacementCode=M),a(O=>[...O,C]),f(""),$("")},W=C=>{a(O=>O.filter(H=>H.id!==C))},R=async()=>{await navigator.clipboard.writeText(_),E(!0),setTimeout(()=>E(!1),2e3)},A=()=>{i==null||i(_),de()},de=()=>{d(""),a([]),m(null),j(null),E(!1),f(""),$(""),n()};return e.jsx(le,{isOpen:t,onClose:de,title:`Amendment ${l} Builder`,size:"xl",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-text-secondary mb-1",children:"Amendment Description"}),e.jsx(J,{value:c,onChange:C=>d(C.target.value),placeholder:"e.g., Increase leverage covenant threshold following Q3 waiver"})]}),x.length>0&&e.jsxs("div",{children:[e.jsxs("h4",{className:"text-sm font-semibold text-text-primary mb-3",children:["Amendment Directives (",x.length,")"]}),e.jsx("div",{className:"space-y-2",children:x.map(C=>e.jsxs("div",{className:"flex items-center justify-between p-3 rounded-lg border border-border-DEFAULT bg-surface-1",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(xe,{variant:C.type==="DELETES"?"danger":C.type==="ADDS"?"success":C.type==="REPLACES"?"warning":"info",size:"sm",children:C.type}),e.jsxs("span",{className:"text-sm text-text-primary",children:[C.targetType," ",e.jsx("span",{className:"font-mono text-gold-400",children:C.targetName})]}),C.modifyField&&e.jsxs("span",{className:"text-xs text-text-muted",children:["→ ",C.modifyField," ",C.newValue]})]}),e.jsx(I,{variant:"ghost",size:"sm",onClick:()=>W(C.id),className:"text-danger hover:text-danger/80",children:e.jsx(Zt,{className:"w-3 h-3"})})]},C.id))})]}),e.jsxs("div",{className:"rounded-lg border border-border-DEFAULT bg-surface-1 p-4",children:[e.jsxs("h4",{className:"text-sm font-semibold text-text-primary mb-3 flex items-center gap-2",children:[e.jsx(Ze,{className:"w-4 h-4 text-text-muted"}),"Add Directive"]}),e.jsxs("div",{className:"grid grid-cols-4 gap-3 mb-3",children:[e.jsx(X,{value:D,onChange:C=>y(C.target.value),options:[{value:"MODIFIES",label:"MODIFIES"},{value:"REPLACES",label:"REPLACES"},{value:"ADDS",label:"ADDS"},{value:"DELETES",label:"DELETES"}]}),e.jsx(X,{value:b,onChange:C=>w(C.target.value),options:[{value:"COVENANT",label:"Covenant"},{value:"BASKET",label:"Basket"},{value:"DEFINE",label:"Definition"}]}),e.jsx(J,{value:v,onChange:C=>f(C.target.value),placeholder:"Element name"}),D==="MODIFIES"&&e.jsx(X,{value:S,onChange:C=>F(C.target.value),options:[{value:"REQUIRES",label:"REQUIRES"},{value:"CAPACITY",label:"CAPACITY"},{value:"FLOOR",label:"FLOOR"},{value:"MAXIMUM",label:"MAXIMUM"},{value:"TESTED",label:"TESTED"}]})]}),D!=="DELETES"&&e.jsx("div",{className:"mb-3",children:e.jsx(J,{value:M,onChange:C=>$(C.target.value),placeholder:D==="MODIFIES"?"e.g., Leverage <= 5.25":"Full ProViso code for the new element"})}),e.jsx(I,{variant:"secondary",size:"sm",onClick:oe,icon:e.jsx(Ze,{className:"w-3 h-3"}),disabled:!v.trim(),children:"Add"})]}),x.length>0&&e.jsxs(is,{defaultTab:"diff",children:[e.jsxs(ls,{children:[e.jsx(Re,{id:"diff",children:"Visual Diff"}),e.jsx(Re,{id:"code",children:"Amendment Code"}),e.jsx(Re,{id:"impact",children:"Impact Analysis"})]}),e.jsx(Ie,{id:"diff",children:e.jsx(hs,{fromCode:s,toCode:k,fromLabel:"Current Agreement",toLabel:"After Amendment",maxHeight:"300px"})}),e.jsx(Ie,{id:"code",children:e.jsxs("div",{className:"rounded-lg border border-border-DEFAULT bg-surface-2 overflow-hidden",children:[e.jsxs("div",{className:"px-4 py-2 bg-surface-3 border-b border-border-DEFAULT flex items-center justify-between",children:[e.jsxs("span",{className:"text-sm text-text-tertiary",children:["Amendment ",l," — ProViso syntax"]}),e.jsx(I,{variant:"ghost",size:"sm",icon:N?e.jsx(Ce,{className:"w-3 h-3 text-success"}):e.jsx(bt,{className:"w-3 h-3"}),onClick:R,children:N?"Copied":"Copy"})]}),e.jsx("pre",{className:"p-4 text-sm font-mono text-text-secondary overflow-auto max-h-[300px]",children:e.jsx("code",{children:_})})]})}),e.jsxs(Ie,{id:"impact",children:[h&&e.jsxs("div",{className:"flex items-center gap-3 p-4",children:[e.jsx(me,{className:"w-4 h-4 text-gold-500 animate-spin"}),e.jsx("span",{className:"text-sm text-text-tertiary",children:"Computing impact..."})]}),u&&e.jsxs("div",{className:"flex items-center gap-3 p-4 text-sm text-danger",children:[e.jsx(se,{className:"w-4 h-4"}),e.jsx("span",{children:u})]}),!h&&!u&&o&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-4 gap-3",children:[e.jsxs("div",{className:"rounded-lg bg-surface-1 border border-border-DEFAULT p-3 text-center",children:[e.jsx("p",{className:"text-2xl font-bold text-text-primary",children:o.totalChanges}),e.jsx("p",{className:"text-xs text-text-muted",children:"Total Changes"})]}),e.jsxs("div",{className:"rounded-lg bg-success/5 border border-success/20 p-3 text-center",children:[e.jsx("p",{className:"text-2xl font-bold text-success",children:o.borrowerFavorable}),e.jsx("p",{className:"text-xs text-text-muted",children:"Borrower Fav."})]}),e.jsxs("div",{className:"rounded-lg bg-danger/5 border border-danger/20 p-3 text-center",children:[e.jsx("p",{className:"text-2xl font-bold text-danger",children:o.lenderFavorable}),e.jsx("p",{className:"text-xs text-text-muted",children:"Lender Fav."})]}),e.jsxs("div",{className:"rounded-lg bg-surface-1 border border-border-DEFAULT p-3 text-center",children:[e.jsx("p",{className:"text-2xl font-bold text-text-tertiary",children:o.neutral}),e.jsx("p",{className:"text-xs text-text-muted",children:"Neutral"})]})]}),e.jsx("div",{className:"space-y-2",children:o.changes.map(C=>{const O={borrower_favorable:{border:"border-l-success",bg:"bg-success/5",label:"Borrower"},lender_favorable:{border:"border-l-danger",bg:"bg-danger/5",label:"Lender"},neutral:{border:"border-l-text-muted",bg:"bg-surface-2/50",label:"Neutral"},unclear:{border:"border-l-border-strong",bg:"",label:"Unclear"}},H=O[C.impact]||O.unclear;return e.jsxs("div",{className:`border-l-4 rounded-r-lg p-3 ${H.border} ${H.bg}`,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(xe,{variant:"muted",size:"sm",children:C.elementType}),e.jsx("span",{className:"text-sm font-medium text-text-primary",children:C.title})]}),e.jsx(xe,{variant:C.impact==="borrower_favorable"?"success":C.impact==="lender_favorable"?"danger":"muted",size:"sm",children:H.label})]}),e.jsx("p",{className:"text-xs text-text-tertiary mt-1",children:C.description}),C.beforeValue&&C.afterValue&&e.jsxs("div",{className:"flex items-center gap-2 mt-2 text-xs",children:[e.jsx("span",{className:"text-text-muted line-through",children:C.beforeValue}),e.jsx(Te,{className:"w-3 h-3 text-text-muted"}),e.jsx("span",{className:"text-text-primary font-medium",children:C.afterValue})]})]},C.id)})})]}),!h&&!u&&!o&&e.jsxs("div",{className:"text-center py-8 text-text-muted",children:[e.jsx(qe,{className:"w-8 h-8 mx-auto mb-2"}),e.jsx("p",{className:"text-sm",children:"Add directives above to see impact analysis"})]})]})]}),x.length>0&&e.jsxs("div",{className:"flex items-center justify-between pt-2 border-t border-border-DEFAULT",children:[e.jsxs("p",{className:"text-xs text-text-muted",children:[x.length," directive",x.length!==1?"s":""," in this amendment"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(I,{variant:"ghost",onClick:de,children:"Cancel"}),e.jsx(I,{variant:"gold",onClick:A,icon:e.jsx(Nt,{className:"w-4 h-4"}),children:"Generate Amendment"})]})]})]})})}function ra({guarantees:t,degradation:n,title:s="Performance Guarantees"}){const r=t[0];if(!r)return null;const l=[{name:"P99",value:r.p99,threshold:"p99"},r.p90&&{name:"P90",value:r.p90,threshold:"p90"},r.p75&&{name:"P75",value:r.p75,threshold:"p75"},{name:"P50",value:r.p50,threshold:"p50"}].filter(Boolean),i=a=>{switch(a){case"p50":return"text-success";case"p75":return"text-green-400";case"p90":return"text-yellow-400";case"p99":return"text-warning";default:return"text-danger"}},c=a=>{switch(a){case"p50":return"bg-success/10 border-success/30";case"p75":return"bg-green-500/10 border-green-500/30";case"p90":return"bg-yellow-500/10 border-yellow-500/30";case"p99":return"bg-warning/10 border-warning/30";default:return"bg-danger/10 border-danger/30"}},d=a=>a?e.jsx(z,{className:"w-4 h-4 text-success"}):e.jsx(V,{className:"w-4 h-4 text-danger"}),x=({active:a,payload:o})=>{if(!a||!o||!o[0])return null;const m=o[0].payload;return e.jsxs("div",{className:"bg-surface-2 border border-border-DEFAULT rounded-lg px-3 py-2 shadow-lg",children:[e.jsxs("p",{className:"text-sm font-medium text-text-primary",children:[m.name," Threshold"]}),e.jsxs("p",{className:"text-sm text-text-tertiary",children:[m.value.toLocaleString()," ",r.unit||"GWh"]})]})};return e.jsxs(U,{children:[e.jsx(q,{title:s,subtitle:`${r.metric} performance tracking`,action:e.jsxs("div",{className:"flex items-center gap-2",children:[d(r.meetsGuarantee),e.jsx("span",{className:`text-sm font-medium ${r.meetsGuarantee?"text-success":"text-danger"}`,children:r.meetsGuarantee?"Meeting Guarantee":"Below Guarantee"})]})}),e.jsxs(B,{children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"text-3xl font-bold text-text-primary",children:[r.actual.toLocaleString(),e.jsx("span",{className:"text-lg text-text-tertiary ml-1",children:r.unit||"GWh"})]}),e.jsxs("p",{className:"text-sm text-text-tertiary mt-1",children:["Actual vs P50: ",r.p50.toLocaleString()]})]}),e.jsxs("div",{className:`px-4 py-2 rounded-lg border ${c(r.performanceLevel)}`,children:[e.jsx("p",{className:"text-xs text-text-tertiary",children:"Performance Level"}),e.jsx("p",{className:`text-lg font-bold ${i(r.performanceLevel)}`,children:r.performanceLevel.toUpperCase()})]})]}),e.jsx("div",{className:"h-40 mb-4",children:e.jsx(fe,{width:"100%",height:"100%",children:e.jsxs(ds,{data:l,margin:{top:10,right:10,left:0,bottom:0},children:[e.jsx(St,{strokeDasharray:"3 3",stroke:"#374151"}),e.jsx(Se,{dataKey:"name",tick:{fill:"#9ca3af",fontSize:12},axisLine:{stroke:"#4b5563"}}),e.jsx(Ae,{tick:{fill:"#9ca3af",fontSize:12},axisLine:{stroke:"#4b5563"},tickFormatter:a=>`${(a/1).toFixed(0)}`}),e.jsx(De,{content:e.jsx(x,{})}),e.jsx(xs,{type:"monotone",dataKey:"value",stroke:"#3b82f6",fill:"url(#performanceGradient)",strokeWidth:2}),e.jsx(He,{y:r.actual,stroke:"#22c55e",strokeWidth:2,strokeDasharray:"5 5",label:{value:`Actual: ${r.actual}`,position:"right",fill:"#22c55e",fontSize:11}}),e.jsx("defs",{children:e.jsxs("linearGradient",{id:"performanceGradient",x1:"0",y1:"0",x2:"0",y2:"1",children:[e.jsx("stop",{offset:"5%",stopColor:"#3b82f6",stopOpacity:.3}),e.jsx("stop",{offset:"95%",stopColor:"#3b82f6",stopOpacity:0})]})})]})})}),e.jsx("div",{className:"space-y-2",children:t.map(a=>e.jsxs("div",{className:`flex items-center justify-between p-3 rounded-lg ${a.meetsGuarantee?"bg-success/5":"bg-danger/5"}`,children:[e.jsxs("div",{className:"flex items-center gap-3",children:[a.meetsGuarantee?e.jsx(ie,{className:"w-4 h-4 text-success"}):e.jsx(Ve,{className:"w-4 h-4 text-danger"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-text-primary",children:a.name}),e.jsx("p",{className:"text-xs text-text-tertiary",children:a.metric})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("p",{className:`text-sm font-semibold ${a.meetsGuarantee?"text-success":"text-danger"}`,children:[a.actual.toLocaleString()," / ",a.p99.toLocaleString()]}),e.jsx("p",{className:`text-xs ${i(a.performanceLevel)}`,children:a.performanceLevel.toUpperCase()})]})]},a.name))}),n&&n.length>0&&e.jsxs("div",{className:"mt-4 pt-4 border-t border-border-DEFAULT",children:[e.jsx("p",{className:"text-sm font-medium text-text-secondary mb-2",children:"Degradation Impact"}),e.jsx("div",{className:"grid grid-cols-2 gap-3",children:n.slice(0,2).map(a=>e.jsxs("div",{className:"bg-surface-2/50 rounded-lg p-3",children:[e.jsx("p",{className:"text-xs text-text-tertiary",children:a.assetType}),e.jsxs("p",{className:"text-sm font-medium text-text-primary",children:[a.effectiveCapacity.toFixed(1),"% capacity"]}),e.jsxs("p",{className:"text-xs text-warning",children:["-",a.cumulativeDegradation.toFixed(1),"% YTD"]})]},a.name))})]})]})]})}function na({requirements:t,title:n="Regulatory Status"}){const[s,r]=g.useState(null),l=t.reduce((m,h)=>(m[h.agency]||(m[h.agency]=[]),m[h.agency].push(h),m),{}),i={total:t.length,approved:t.filter(m=>m.status==="approved").length,pending:t.filter(m=>m.status==="pending").length,submitted:t.filter(m=>m.status==="submitted").length,denied:t.filter(m=>m.status==="denied").length},c={development:t.filter(m=>m.requiredFor==="Development"),construction:t.filter(m=>m.requiredFor==="Construction"),operations:t.filter(m=>m.requiredFor==="Operations")},d=m=>{switch(m){case"approved":return e.jsx(z,{className:"w-4 h-4 text-success"});case"submitted":return e.jsx(ee,{className:"w-4 h-4 text-info"});case"pending":return e.jsx(se,{className:"w-4 h-4 text-warning"});case"denied":return e.jsx(Q,{className:"w-4 h-4 text-danger"});default:return e.jsx(ee,{className:"w-4 h-4 text-text-tertiary"})}},x=m=>{switch(m){case"approved":return"text-success bg-success/10";case"submitted":return"text-info bg-info/10";case"pending":return"text-warning bg-warning/10";case"denied":return"text-danger bg-danger/10";default:return"text-text-tertiary bg-gray-500/10"}},a=m=>m?new Date(m).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}):"-",o=m=>{const h=m.filter(p=>p.status==="approved").length;return Math.round(h/m.length*100)};return e.jsxs(U,{children:[e.jsx(q,{title:n,subtitle:`${i.approved}/${i.total} permits approved`,action:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-20 h-2 bg-surface-3 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-success transition-all",style:{width:`${i.approved/i.total*100}%`}})}),e.jsxs("span",{className:"text-sm font-medium text-success",children:[Math.round(i.approved/i.total*100),"%"]})]})}),e.jsxs(B,{children:[e.jsxs("div",{className:"grid grid-cols-4 gap-2 mb-4",children:[e.jsxs("div",{className:"bg-success/10 rounded-lg p-2 text-center",children:[e.jsx("p",{className:"text-lg font-bold text-success",children:i.approved}),e.jsx("p",{className:"text-xs text-text-tertiary",children:"Approved"})]}),e.jsxs("div",{className:"bg-info/10 rounded-lg p-2 text-center",children:[e.jsx("p",{className:"text-lg font-bold text-info",children:i.submitted}),e.jsx("p",{className:"text-xs text-text-tertiary",children:"Submitted"})]}),e.jsxs("div",{className:"bg-warning/10 rounded-lg p-2 text-center",children:[e.jsx("p",{className:"text-lg font-bold text-warning",children:i.pending}),e.jsx("p",{className:"text-xs text-text-tertiary",children:"Pending"})]}),e.jsxs("div",{className:"bg-danger/10 rounded-lg p-2 text-center",children:[e.jsx("p",{className:"text-lg font-bold text-danger",children:i.denied}),e.jsx("p",{className:"text-xs text-text-tertiary",children:"Denied"})]})]}),e.jsx("div",{className:"flex gap-2 mb-4 text-xs",children:Object.entries(c).map(([m,h])=>{const p=h.filter(j=>j.status==="approved").length,u=h.length;return e.jsxs("div",{className:`flex-1 px-2 py-1.5 rounded-lg ${p===u?"bg-success/10":"bg-surface-2"}`,children:[e.jsx("p",{className:"text-text-tertiary capitalize",children:m}),e.jsxs("p",{className:`font-medium ${p===u?"text-success":"text-text-primary"}`,children:[p,"/",u]})]},m)})}),e.jsx("div",{className:"space-y-2",children:Object.entries(l).map(([m,h])=>{const p=s===m,u=o(h);return e.jsxs("div",{className:"border border-border-DEFAULT rounded-lg overflow-hidden",children:[e.jsxs("button",{onClick:()=>r(p?null:m),className:"w-full flex items-center justify-between p-3 hover:bg-surface-2/50 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Xt,{className:"w-4 h-4 text-text-tertiary"}),e.jsxs("div",{className:"text-left",children:[e.jsx("p",{className:"text-sm font-medium text-text-primary",children:m}),e.jsxs("p",{className:"text-xs text-text-tertiary",children:[h.length," permit",h.length!==1?"s":""]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-16 h-1.5 bg-surface-3 rounded-full overflow-hidden",children:e.jsx("div",{className:`h-full transition-all ${u===100?"bg-success":"bg-info"}`,style:{width:`${u}%`}})}),e.jsxs("span",{className:`text-xs font-medium ${u===100?"text-success":"text-text-tertiary"}`,children:[u,"%"]})]}),p?e.jsx(Jt,{className:"w-4 h-4 text-text-tertiary"}):e.jsx(Ee,{className:"w-4 h-4 text-text-tertiary"})]})]}),p&&e.jsx("div",{className:"border-t border-border-DEFAULT divide-y divide-border-DEFAULT",children:h.map(j=>e.jsxs("div",{className:"p-3 bg-surface-0/50",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-start gap-2",children:[d(j.status),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-text-primary",children:j.name}),e.jsx("p",{className:"text-xs text-text-tertiary",children:j.type})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("span",{className:`text-xs px-2 py-0.5 rounded-full ${x(j.status)}`,children:j.status}),j.approvalDate&&e.jsx("p",{className:"text-xs text-text-muted mt-1",children:a(j.approvalDate)})]})]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("span",{className:"text-xs text-text-muted",children:"Required for:"}),e.jsx("span",{className:"text-xs px-2 py-0.5 rounded bg-surface-2 text-text-secondary",children:j.requiredFor})]})]},j.name))})]},m)})})]})]})}function ia({milestones:t,title:n="Technical Progress"}){const s=t.reduce((u,j)=>u+j.targetValue,0),r=t.reduce((u,j)=>u+j.currentValue,0),l=s>0?r/s*100:0,i=t.find(u=>u.measurement.toLowerCase().includes("mw")||u.measurement.toLowerCase().includes("capacity"))||t[0],c={achieved:t.filter(u=>u.status==="achieved").length,inProgress:t.filter(u=>u.status==="in_progress").length,pending:t.filter(u=>u.status==="pending").length,atRisk:t.filter(u=>u.status==="at_risk").length,breached:t.filter(u=>u.status==="breached").length},d=u=>{switch(u){case"achieved":return"#22c55e";case"in_progress":return"#3b82f6";case"pending":return"#6b7280";case"at_risk":return"#f59e0b";case"breached":return"#ef4444";default:return"#6b7280"}},x=u=>{switch(u){case"achieved":return"bg-success/10 border-success/30 text-success";case"in_progress":return"bg-info/10 border-info/30 text-info";case"pending":return"bg-gray-500/10 border-gray-500/30 text-text-tertiary";case"at_risk":return"bg-warning/10 border-warning/30 text-warning";case"breached":return"bg-danger/10 border-danger/30 text-danger";default:return"bg-gray-500/10 border-gray-500/30 text-text-tertiary"}},a=u=>{switch(u){case"achieved":return e.jsx(z,{className:"w-4 h-4 text-success"});case"in_progress":return e.jsx(ee,{className:"w-4 h-4 text-info"});case"at_risk":case"breached":return e.jsx(V,{className:"w-4 h-4 text-warning"});default:return e.jsx(ee,{className:"w-4 h-4 text-text-tertiary"})}},o=t.slice(0,6).map(u=>({name:u.name.length>15?u.name.substring(0,12)+"...":u.name,fullName:u.name,current:u.currentValue,target:u.targetValue,percent:u.percentComplete,status:u.status,measurement:u.measurement})),m=({active:u,payload:j})=>{if(!u||!j||!j[0])return null;const N=j[0].payload;return e.jsxs("div",{className:"bg-industry-cardBg border border-industry-borderDefault rounded-lg px-3 py-2 shadow-lg",children:[e.jsx("p",{className:"text-sm font-medium text-industry-textPrimary",children:N.fullName}),e.jsxs("p",{className:"text-sm text-industry-textSecondary",children:[N.current.toLocaleString()," / ",N.target.toLocaleString()," ",N.measurement]}),e.jsxs("p",{className:"text-xs text-industry-textMuted mt-1",children:[N.percent,"% complete"]})]})},h=u=>new Date(u).toLocaleDateString("en-US",{month:"short",day:"numeric"}),p=u=>{const j=new Date(u),N=new Date;return Math.ceil((j.getTime()-N.getTime())/(1e3*60*60*24))};return e.jsxs(U,{children:[e.jsx(q,{title:n,subtitle:`${c.achieved}/${t.length} milestones achieved`,action:i&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(jt,{className:"w-4 h-4 text-gold-400"}),e.jsxs("span",{className:"text-lg font-bold text-text-primary",children:[i.currentValue,e.jsxs("span",{className:"text-text-tertiary text-sm",children:["/",i.targetValue]})]}),e.jsx("span",{className:"text-sm text-text-tertiary",children:i.measurement})]})}),e.jsxs(B,{children:[e.jsxs("div",{className:"mb-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"text-sm text-industry-textSecondary",children:"Overall Technical Progress"}),e.jsxs("span",{className:"text-sm font-medium text-industry-textPrimary",children:[l.toFixed(1),"%"]})]}),e.jsx("div",{className:"h-3 bg-industry-headerBg rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-gradient-to-r from-blue-500 to-emerald-500 transition-all duration-500",style:{width:`${Math.min(l,100)}%`}})})]}),e.jsxs("div",{className:"grid grid-cols-5 gap-2 mb-4",children:[e.jsxs("div",{className:"bg-success/10 rounded-lg p-2 text-center",children:[e.jsx("p",{className:"text-lg font-bold text-success",children:c.achieved}),e.jsx("p",{className:"text-xs text-text-tertiary",children:"Done"})]}),e.jsxs("div",{className:"bg-info/10 rounded-lg p-2 text-center",children:[e.jsx("p",{className:"text-lg font-bold text-info",children:c.inProgress}),e.jsx("p",{className:"text-xs text-text-tertiary",children:"Active"})]}),e.jsxs("div",{className:"bg-gray-500/10 rounded-lg p-2 text-center",children:[e.jsx("p",{className:"text-lg font-bold text-text-tertiary",children:c.pending}),e.jsx("p",{className:"text-xs text-text-tertiary",children:"Pending"})]}),e.jsxs("div",{className:"bg-warning/10 rounded-lg p-2 text-center",children:[e.jsx("p",{className:"text-lg font-bold text-warning",children:c.atRisk}),e.jsx("p",{className:"text-xs text-text-tertiary",children:"At Risk"})]}),e.jsxs("div",{className:"bg-danger/10 rounded-lg p-2 text-center",children:[e.jsx("p",{className:"text-lg font-bold text-danger",children:c.breached}),e.jsx("p",{className:"text-xs text-text-tertiary",children:"Breached"})]})]}),e.jsx("div",{className:"h-36 mb-4",children:e.jsx(fe,{width:"100%",height:"100%",children:e.jsxs(Ct,{data:o,margin:{top:5,right:5,left:0,bottom:5},children:[e.jsx(Se,{dataKey:"name",tick:{fill:"#9ca3af",fontSize:10},axisLine:{stroke:"#4b5563"},angle:-15,textAnchor:"end",height:40}),e.jsx(Ae,{hide:!0}),e.jsx(De,{content:e.jsx(m,{})}),e.jsx(Et,{dataKey:"percent",radius:[4,4,0,0],children:o.map((u,j)=>e.jsx(Tt,{fill:d(u.status)},`cell-${j}`))})]})})}),e.jsx("div",{className:"space-y-2",children:t.map(u=>e.jsxs("div",{className:`flex items-center justify-between p-3 rounded-lg border ${x(u.status)}`,children:[e.jsxs("div",{className:"flex items-center gap-3",children:[a(u.status),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-text-primary",children:u.name}),e.jsx("p",{className:"text-xs text-text-tertiary",children:u.measurement})]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"text-right",children:[e.jsxs("p",{className:"text-sm font-medium text-text-primary tabular-nums",children:[u.currentValue.toLocaleString()," / ",u.targetValue.toLocaleString()]}),e.jsxs("p",{className:"text-xs text-text-tertiary",children:[u.percentComplete,"%"]})]}),e.jsxs("div",{className:"text-right min-w-[60px]",children:[e.jsx("p",{className:"text-xs text-text-tertiary",children:h(u.target)}),u.status!=="achieved"&&e.jsx("p",{className:`text-xs ${p(u.target)<0?"text-danger":p(u.target)<30?"text-warning":"text-text-muted"}`,children:p(u.target)<0?`${Math.abs(p(u.target))}d overdue`:`${p(u.target)}d left`})]})]})]},u.name))}),t.filter(u=>u.status==="in_progress").length>0&&e.jsxs("div",{className:"mt-4 pt-4 border-t border-industry-borderDefault",children:[e.jsx("p",{className:"text-xs text-text-tertiary mb-2",children:"Critical Path"}),e.jsx("div",{className:"flex items-center gap-2 flex-wrap",children:t.filter(u=>u.status==="in_progress"||u.status==="pending").slice(0,4).map((u,j,N)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:`text-xs px-2 py-1 rounded ${u.status==="in_progress"?"bg-info/20 text-info":"bg-gray-500/20 text-text-tertiary"}`,children:u.name}),j<N.length-1&&e.jsx(Te,{className:"w-3 h-3 text-text-muted"})]},u.name))})]})]})]})}function la({structure:t,credits:n,depreciation:s,flipEvents:r,title:l="Tax Equity Status"}){const i=a=>a>=1e9?`$${(a/1e9).toFixed(1)}B`:a>=1e6?`$${(a/1e6).toFixed(1)}M`:a>=1e3?`$${(a/1e3).toFixed(0)}K`:`$${a.toFixed(0)}`,c=(n==null?void 0:n.reduce((a,o)=>a+o.creditAmount,0))||0,d=(r==null?void 0:r.find(a=>a.trigger==="target_return"))||(r==null?void 0:r[0]),x=d&&d.targetValue&&d.currentValue?d.currentValue/d.targetValue*100:0;return e.jsxs(U,{children:[e.jsx(q,{title:l,subtitle:(t==null?void 0:t.structureType.replace("_"," "))||"Tax structure overview",action:t&&e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("span",{className:`text-xs px-2 py-1 rounded-full ${t.hasFlipped?"bg-success/10 text-success":"bg-info/10 text-info"}`,children:t.hasFlipped?"Post-Flip":"Pre-Flip"})})}),e.jsxs(B,{children:[t&&e.jsxs("div",{className:"mb-6 p-4 bg-surface-2/50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("p",{className:"text-sm font-medium text-text-secondary",children:"Partnership Allocations"}),e.jsx(es,{className:"w-4 h-4 text-text-tertiary"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between text-xs mb-1",children:[e.jsx("span",{className:"text-text-tertiary",children:"Tax Credits"}),e.jsxs("span",{className:"text-text-secondary",children:[t.taxCreditAllocation.investor,"/",t.taxCreditAllocation.sponsor]})]}),e.jsxs("div",{className:"h-2 bg-surface-3 rounded-full overflow-hidden flex",children:[e.jsx("div",{className:"h-full bg-info",style:{width:`${t.taxCreditAllocation.investor}%`}}),e.jsx("div",{className:"h-full bg-success",style:{width:`${t.taxCreditAllocation.sponsor}%`}})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between text-xs mb-1",children:[e.jsx("span",{className:"text-text-tertiary",children:"Cash Distribution"}),e.jsxs("span",{className:"text-text-secondary",children:[t.cashAllocation.investor,"/",t.cashAllocation.sponsor]})]}),e.jsxs("div",{className:"h-2 bg-surface-3 rounded-full overflow-hidden flex",children:[e.jsx("div",{className:"h-full bg-info",style:{width:`${t.cashAllocation.investor}%`}}),e.jsx("div",{className:"h-full bg-success",style:{width:`${t.cashAllocation.sponsor}%`}})]})]})]}),e.jsxs("div",{className:"flex items-center gap-4 mt-3 text-xs",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"w-2 h-2 bg-info rounded"}),e.jsx("span",{className:"text-text-tertiary",children:"Tax Investor"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"w-2 h-2 bg-success rounded"}),e.jsx("span",{className:"text-text-tertiary",children:"Sponsor"})]})]}),t.targetReturn&&e.jsx("div",{className:"mt-4 pt-3 border-t border-border-DEFAULT",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-text-tertiary",children:"Target IRR"}),e.jsxs("p",{className:"text-lg font-bold text-text-primary",children:[t.targetReturn,"%"]})]}),t.currentIRR!==void 0&&e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-xs text-text-tertiary",children:"Current IRR"}),e.jsxs("p",{className:`text-lg font-bold ${t.currentIRR>=t.targetReturn?"text-success":"text-info"}`,children:[t.currentIRR,"%"]})]})]})})]}),n&&n.length>0&&e.jsxs("div",{className:"mb-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("p",{className:"text-sm font-medium text-text-secondary",children:"Tax Credits"}),e.jsx("p",{className:"text-sm font-bold text-gold-400",children:i(c)})]}),e.jsx("div",{className:"space-y-2",children:n.map(a=>e.jsxs("div",{className:"p-3 bg-surface-2/50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(re,{className:"w-4 h-4 text-gold-400"}),e.jsx("span",{className:"text-sm font-medium text-text-primary",children:a.name})]}),e.jsx("span",{className:"text-xs px-2 py-0.5 rounded bg-gold-500/10 text-gold-400 uppercase",children:a.creditType})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-2 text-xs",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-text-tertiary",children:"Base Rate"}),e.jsxs("p",{className:"text-text-primary font-medium",children:[a.baseRate,"%"]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-text-tertiary",children:"Effective"}),e.jsxs("p",{className:"text-success font-medium",children:[a.effectiveRate,"%"]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-text-tertiary",children:"Amount"}),e.jsx("p",{className:"text-text-primary font-medium",children:i(a.creditAmount)})]})]}),a.adders&&a.adders.length>0&&e.jsxs("div",{className:"mt-2 pt-2 border-t border-border-DEFAULT",children:[e.jsx("p",{className:"text-xs text-text-tertiary mb-1",children:"Adders:"}),e.jsx("div",{className:"flex gap-2 flex-wrap",children:a.adders.map(o=>e.jsxs("span",{className:"text-xs px-2 py-0.5 rounded bg-success/10 text-success",children:["+",o.bonus,"% ",o.name.replace("_"," ")]},o.name))})]}),a.vestingPeriod&&e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("div",{className:"flex-1 h-1.5 bg-surface-3 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-success",style:{width:`${a.percentVested||0}%`}})}),e.jsxs("span",{className:"text-xs text-text-tertiary",children:[a.percentVested||0,"% vested"]})]})]},a.name))})]}),s&&s.length>0&&e.jsxs("div",{className:"mb-6",children:[e.jsx("p",{className:"text-sm font-medium text-text-secondary mb-3",children:"Depreciation"}),e.jsx("div",{className:"space-y-2",children:s.map(a=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-surface-2/50 rounded-lg",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-text-primary",children:a.name}),e.jsx("p",{className:"text-xs text-text-tertiary",children:a.method.replace("_"," ").toUpperCase()})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-sm font-medium text-text-primary",children:i(a.cumulativeDepreciation)}),e.jsxs("p",{className:"text-xs text-text-tertiary",children:["of ",i(a.depreciableBasis)]})]})]},a.name))})]}),r&&r.length>0&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-text-secondary mb-3",children:"Flip Events"}),e.jsx("div",{className:"space-y-2",children:r.map(a=>{var o;return e.jsxs("div",{className:`p-3 rounded-lg border ${a.hasTriggered?"bg-success/5 border-success/30":"bg-surface-2/50 border-border-DEFAULT"}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[a.trigger==="target_return"?e.jsx(ie,{className:"w-4 h-4 text-info"}):e.jsx(ut,{className:"w-4 h-4 text-warning"}),e.jsx("span",{className:"text-sm font-medium text-text-primary",children:a.name})]}),e.jsx("span",{className:`text-xs px-2 py-0.5 rounded ${a.hasTriggered?"bg-success/10 text-success":"bg-gray-500/10 text-text-tertiary"}`,children:a.hasTriggered?"Triggered":"Pending"})]}),a.trigger==="target_return"&&a.targetValue&&e.jsxs("div",{className:"mb-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs mb-1",children:[e.jsxs("span",{className:"text-text-tertiary",children:["Progress to ",a.targetValue,"% IRR"]}),e.jsxs("span",{className:"text-text-secondary",children:[((o=a.currentValue)==null?void 0:o.toFixed(1))||0,"%"]})]}),e.jsx("div",{className:"h-2 bg-surface-3 rounded-full overflow-hidden",children:e.jsx("div",{className:`h-full transition-all ${a.hasTriggered?"bg-success":"bg-info"}`,style:{width:`${Math.min(x,100)}%`}})})]}),a.trigger==="date_certain"&&a.projectedFlipDate&&e.jsxs("p",{className:"text-xs text-text-tertiary",children:["Flip date: ",new Date(a.projectedFlipDate).toLocaleDateString()]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2 text-xs",children:[e.jsxs("span",{className:"text-text-tertiary",children:[a.preFlipAllocation.investor,"/",a.preFlipAllocation.sponsor]}),e.jsx(Te,{className:"w-3 h-3 text-text-muted"}),e.jsxs("span",{className:a.hasTriggered?"text-success":"text-text-tertiary",children:[a.postFlipAllocation.investor,"/",a.postFlipAllocation.sponsor]})]})]},a.name)})})]}),!t&&!(n!=null&&n.length)&&!(s!=null&&s.length)&&!(r!=null&&r.length)&&e.jsxs("div",{className:"text-center py-8",children:[e.jsx(ts,{className:"w-8 h-8 text-text-muted mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-text-tertiary",children:"No tax equity structure configured"})]})]})]})}const ae={net_income:16e6,interest_expense:14e6,tax_expense:45e5,depreciation:26e6,amortization:25e5,senior_debt:19e7,subordinated_debt:28e6,senior_interest:95e5,senior_principal:6e6,total_project_cost:28e7,equity_contributed:84e6,monthly_debt_service:13e5,annual_capex_budget:26e5,operating_expenses:52e5,distributions:6e6,Revenue:38e6,total_assets:295e6,annual_gwh:475,availability_pct:98.2},ca=[{name:"Income Statement",description:"Revenue and expense items",fields:[{key:"Revenue",label:"Revenue",helpText:"Total revenue for the period"},{key:"net_income",label:"Net Income",helpText:"Bottom line profit"},{key:"interest_expense",label:"Interest Expense",helpText:"Total interest paid on debt"},{key:"tax_expense",label:"Tax Expense",helpText:"Income tax expense"},{key:"depreciation",label:"Depreciation",helpText:"Non-cash depreciation expense"},{key:"amortization",label:"Amortization",helpText:"Non-cash amortization expense"}]},{name:"Debt Structure",description:"Outstanding debt and service",fields:[{key:"senior_debt",label:"Senior Debt",helpText:"Outstanding senior debt balance"},{key:"subordinated_debt",label:"Subordinated Debt",helpText:"Outstanding subordinated debt"},{key:"senior_interest",label:"Senior Interest",helpText:"Senior debt interest payment"},{key:"senior_principal",label:"Senior Principal",helpText:"Senior debt principal payment"}]},{name:"Project Metrics",description:"Project cost and equity",fields:[{key:"total_project_cost",label:"Total Project Cost",helpText:"Total cost of the project"},{key:"equity_contributed",label:"Equity Contributed",helpText:"Equity invested by sponsors"}]},{name:"Cash Flow",description:"Operating cash flows",fields:[{key:"operating_expenses",label:"Operating Expenses",helpText:"Total operating expenses"},{key:"monthly_debt_service",label:"Monthly Debt Service",helpText:"Monthly P&I payment"},{key:"annual_capex_budget",label:"Annual CapEx Budget",helpText:"Capital expenditure budget"},{key:"distributions",label:"Distributions",helpText:"Cash distributed to equity"}]},{name:"Balance Sheet",description:"Asset values",fields:[{key:"total_assets",label:"Total Assets",helpText:"Total asset value"}]}];function oa(t){return t>=1e6?`$${(t/1e6).toFixed(1)}M`:t>=1e3?`$${(t/1e3).toFixed(0)}K`:`$${t.toFixed(0)}`}function da(t){const n=t.replace(/[$,\s]/g,""),s=parseFloat(n);return isNaN(s)?0:s}function xa({group:t,values:n,onChange:s,expanded:r,onToggle:l}){return e.jsxs("div",{className:"border border-border-DEFAULT rounded-lg overflow-hidden",children:[e.jsxs("button",{onClick:l,className:"w-full flex items-center justify-between px-4 py-3 bg-surface-2/50 hover:bg-surface-2 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[r?e.jsx(Ee,{className:"w-4 h-4 text-text-tertiary"}):e.jsx(Be,{className:"w-4 h-4 text-text-tertiary"}),e.jsx("span",{className:"font-medium text-text-primary",children:t.name}),e.jsxs("span",{className:"text-xs text-text-muted",children:["(",t.fields.length," fields)"]})]}),e.jsx("span",{className:"text-xs text-text-tertiary",children:t.description})]}),r&&e.jsx("div",{className:"p-4 bg-surface-0/30 grid grid-cols-1 sm:grid-cols-2 gap-4",children:t.fields.map(i=>{var c;return e.jsxs("div",{children:[e.jsx(J,{label:i.label,type:"number",value:((c=n[i.key])==null?void 0:c.toString())??"0",onChange:d=>s(i.key,da(d.target.value)),helpText:i.helpText,icon:e.jsx(re,{className:"w-4 h-4"}),size:"sm"}),e.jsx("div",{className:"mt-1 text-xs text-text-muted text-right",children:oa(n[i.key]??0)})]},i.key)})})]})}function ma({className:t="",onClose:n}){const{financials:s,loadFinancials:r,refresh:l}=te(),[i,c]=g.useState(()=>({...ae,...s})),[d,x]=g.useState(()=>new Set(["Income Statement","Debt Structure"])),a=g.useMemo(()=>Object.keys(i).some(j=>i[j]!==s[j]),[i,s]),o=g.useCallback((j,N)=>{c(E=>({...E,[j]:N}))},[]),m=g.useCallback(j=>{x(N=>{const E=new Set(N);return E.has(j)?E.delete(j):E.add(j),E})},[]),h=g.useCallback(()=>{r(i),l()},[i,r,l]),p=g.useCallback(()=>{c({...ae})},[]),u=g.useCallback(()=>{c({...ae,...s})},[s]);return e.jsxs("div",{className:`bg-surface-0/50 border border-surface-2 rounded-xl ${t}`,children:[e.jsxs("div",{className:"flex items-center justify-between px-5 py-4 border-b border-border-DEFAULT",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-text-primary",children:"Financial Data"}),e.jsx("p",{className:"text-sm text-text-tertiary",children:"Edit values to see live impact on covenants"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(I,{variant:"ghost",size:"sm",icon:e.jsx(ss,{className:"w-4 h-4"}),onClick:p,title:"Reset to defaults",children:"Reset"}),n&&e.jsx(I,{variant:"ghost",size:"sm",onClick:n,children:"Close"})]})]}),e.jsx("div",{className:"p-4 space-y-3 max-h-[60vh] overflow-y-auto",children:ca.map(j=>e.jsx(xa,{group:j,values:i,onChange:o,expanded:d.has(j.name),onToggle:()=>m(j.name)},j.name))}),e.jsxs("div",{className:"flex items-center justify-between px-5 py-4 border-t border-border-DEFAULT bg-surface-2/30",children:[e.jsx("div",{className:"text-sm text-text-tertiary",children:a?e.jsx("span",{className:"text-warning",children:"Unsaved changes"}):e.jsx("span",{className:"text-success",children:"All changes applied"})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(I,{variant:"secondary",size:"sm",icon:e.jsx(We,{className:"w-4 h-4"}),onClick:u,disabled:!a,children:"Discard"}),e.jsx(I,{variant:"primary",size:"sm",onClick:h,disabled:!a,children:"Apply & Recalculate"})]})]})]})}function ua(t){return t.endsWith(".proviso")?"proviso":t.endsWith(".json")?"json":"unknown"}function ha({className:t="",onSuccess:n,compact:s=!1,demoMode:r=!1}){const{loadFromCode:l,loadFinancials:i,isLoading:c}=te(),[d,x]=g.useState(!1),[a,o]=g.useState(null),[m,h]=g.useState(!1),p=g.useRef(null),u=g.useCallback(async v=>{const f=ua(v.name);if(f==="unknown"){o({status:"error",fileName:v.name,fileType:f,message:"Unsupported file type. Please upload .proviso or .json files."});return}h(!0),o({status:"loading",fileName:v.name,fileType:f});try{const S=await v.text();if(f==="proviso")await l(S)?(Xe("proviso"),o({status:"success",fileName:v.name,fileType:f,message:"ProViso code loaded successfully"}),n==null||n(f,v.name)):o({status:"error",fileName:v.name,fileType:f,message:"Failed to parse ProViso code. Check syntax."});else if(f==="json")try{const F=JSON.parse(S);if(typeof F!="object"||F===null)throw new Error("JSON must be an object");if(!Object.values(F).some($=>typeof $=="number"))throw new Error("JSON must contain numeric financial values");i(F),Xe("json"),o({status:"success",fileName:v.name,fileType:f,message:`Loaded ${Object.keys(F).length} financial values`}),n==null||n(f,v.name)}catch(F){o({status:"error",fileName:v.name,fileType:f,message:`Invalid JSON: ${F.message}`})}}catch(S){o({status:"error",fileName:v.name,fileType:f,message:`Failed to read file: ${S.message}`})}finally{h(!1)}},[l,i,n]),j=g.useCallback(v=>{var S;const f=(S=v.target.files)==null?void 0:S[0];f&&u(f),p.current&&(p.current.value="")},[u]),N=g.useCallback(v=>{v.preventDefault(),v.stopPropagation(),x(!0)},[]),E=g.useCallback(v=>{v.preventDefault(),v.stopPropagation(),x(!1)},[]),D=g.useCallback(v=>{v.preventDefault(),v.stopPropagation(),x(!1);const f=v.dataTransfer.files[0];f&&u(f)},[u]),y=g.useCallback(()=>{var v;(v=p.current)==null||v.click()},[]),b=g.useCallback(()=>{o(null)},[]),w=m||c;return r?e.jsxs("div",{className:`bg-surface-0/50 border border-surface-2 rounded-xl p-6 text-center ${t}`,children:[e.jsx(we,{className:"w-10 h-10 text-text-muted mx-auto mb-3 opacity-50"}),e.jsx("p",{className:"text-text-secondary font-medium mb-1",children:"File uploads disabled in demo"}),e.jsx("p",{className:"text-sm text-text-muted",children:"This demo uses pre-loaded sample data. In a live deployment, you can upload your own .proviso and .json files."})]}):s?e.jsxs("div",{className:t,children:[e.jsx("input",{ref:p,type:"file",accept:".proviso,.json",onChange:j,className:"hidden"}),e.jsx(I,{variant:"secondary",size:"sm",icon:w?e.jsx(me,{className:"w-4 h-4 animate-spin"}):e.jsx(we,{className:"w-4 h-4"}),onClick:y,disabled:w,children:"Upload File"}),a&&a.status==="error"&&e.jsx("p",{className:"text-danger text-xs mt-1",children:a.message})]}):e.jsxs("div",{className:`bg-surface-0/50 border border-surface-2 rounded-xl ${t}`,children:[e.jsxs("div",{className:"px-5 py-4 border-b border-border-DEFAULT",children:[e.jsx("h3",{className:"text-lg font-semibold text-text-primary",children:"Upload Files"}),e.jsx("p",{className:"text-sm text-text-tertiary",children:"Load ProViso code (.proviso) or financial data (.json)"})]}),e.jsxs("div",{className:"p-5",children:[e.jsxs("div",{onClick:y,onDragOver:N,onDragLeave:E,onDrop:D,className:`
            border-2 border-dashed rounded-lg p-8 text-center cursor-pointer
            transition-colors duration-200
            ${d?"border-gold-500 bg-gold-500/10":"border-border-DEFAULT hover:border-border-strong hover:bg-surface-2/50"}
            ${w?"pointer-events-none opacity-50":""}
          `,children:[e.jsx("input",{ref:p,type:"file",accept:".proviso,.json",onChange:j,className:"hidden"}),w?e.jsx(me,{className:"w-10 h-10 text-gold-500 mx-auto mb-4 animate-spin"}):e.jsx(we,{className:"w-10 h-10 text-text-muted mx-auto mb-4"}),e.jsx("p",{className:"text-text-primary font-medium mb-1",children:d?"Drop file here":"Drag and drop or click to browse"}),e.jsx("p",{className:"text-sm text-text-tertiary",children:"Supports .proviso and .json files"})]}),a&&e.jsxs("div",{className:`
              mt-4 p-4 rounded-lg flex items-start gap-3
              ${a.status==="success"?"bg-success/10 border border-success/20":a.status==="error"?"bg-danger/10 border border-danger/20":"bg-surface-2 border border-border-DEFAULT"}
            `,children:[a.status==="loading"&&e.jsx(me,{className:"w-5 h-5 text-gold-500 animate-spin flex-shrink-0 mt-0.5"}),a.status==="success"&&e.jsx(Ge,{className:"w-5 h-5 text-success flex-shrink-0 mt-0.5"}),a.status==="error"&&e.jsx(se,{className:"w-5 h-5 text-danger flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[a.fileType==="proviso"&&e.jsx(ue,{className:"w-4 h-4 text-text-tertiary"}),a.fileType==="json"&&e.jsx(Oe,{className:"w-4 h-4 text-text-tertiary"}),e.jsx("span",{className:"text-text-primary font-medium truncate",children:a.fileName})]}),a.message&&e.jsx("p",{className:`text-sm mt-1 ${a.status==="success"?"text-success":a.status==="error"?"text-danger":"text-text-tertiary"}`,children:a.message})]}),a.status!=="loading"&&e.jsx("button",{onClick:b,className:"p-1 rounded hover:bg-surface-3 text-text-tertiary hover:text-text-primary transition-colors",children:e.jsx(ze,{className:"w-4 h-4"})})]})]}),e.jsx("div",{className:"px-5 py-4 border-t border-border-DEFAULT bg-surface-2/30",children:e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(ue,{className:"w-4 h-4 text-info mt-0.5"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-text-secondary font-medium",children:".proviso"}),e.jsx("div",{className:"text-text-muted",children:"ProViso agreement code"})]})]}),e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(Oe,{className:"w-4 h-4 text-warning mt-0.5"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-text-secondary font-medium",children:".json"}),e.jsx("div",{className:"text-text-muted",children:"Financial data values"})]})]})]})})]})}function Le(t){return t>=1e9?`$${(t/1e9).toFixed(1)}B`:t>=1e6?`$${(t/1e6).toFixed(1)}M`:t>=1e3?`$${(t/1e3).toFixed(1)}K`:`$${t.toLocaleString()}`}function lt(t){return`${t.toFixed(2)}x`}function Me(t){return`${t.toFixed(1)}%`}function pa(t){return t.toLocaleDateString("en-US",{month:"long",day:"numeric",year:"numeric"})}function ga(t){if(!t.compliant)return"breach";if(t.suspended)return"suspended";const n=t.headroom??100;return n<10?"danger":n<25?"warning":"safe"}function fa(t){switch(t){case"safe":return"Compliant";case"warning":return"Caution";case"danger":return"At Risk";case"breach":return"Breach";case"suspended":return"Suspended";default:return t}}function ja(t){switch(t){case"achieved":return"Achieved";case"in_progress":return"In Progress";case"at_risk":return"At Risk";case"pending":return"Pending";case"breached":return"Breached";default:return t}}function ba(t){const n=new Date;return`
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${t.project.name} - Compliance Certificate</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Georgia', 'Times New Roman', serif;
      font-size: 11pt;
      line-height: 1.5;
      color: #1a1a1a;
      background: white;
      padding: 0.75in;
    }

    /* Header */
    .header {
      text-align: center;
      border-bottom: 2px solid #B8860B;
      padding-bottom: 20px;
      margin-bottom: 24px;
    }

    .header h1 {
      font-size: 18pt;
      font-weight: normal;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      margin-bottom: 8px;
    }

    .header .subtitle {
      font-size: 12pt;
      color: #666;
    }

    .header .project-name {
      font-size: 14pt;
      font-weight: bold;
      margin-top: 12px;
      color: #1a2744;
    }

    /* Metadata */
    .metadata {
      display: flex;
      justify-content: space-between;
      margin-bottom: 24px;
      font-size: 10pt;
      color: #666;
    }

    .metadata-item {
      text-align: left;
    }

    .metadata-item strong {
      color: #1a1a1a;
    }

    /* Summary Box */
    .summary-box {
      background: #f8f8f6;
      border: 1px solid #e0e0dc;
      border-left: 4px solid #B8860B;
      padding: 16px 20px;
      margin-bottom: 24px;
    }

    .summary-box h2 {
      font-size: 12pt;
      font-weight: bold;
      margin-bottom: 8px;
      color: #1a2744;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
    }

    .summary-stat {
      text-align: center;
    }

    .summary-stat .value {
      font-size: 18pt;
      font-weight: bold;
      color: #1a2744;
    }

    .summary-stat .label {
      font-size: 9pt;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    /* Section */
    .section {
      margin-bottom: 24px;
    }

    .section h2 {
      font-size: 12pt;
      font-weight: bold;
      color: #1a2744;
      border-bottom: 1px solid #ddd;
      padding-bottom: 6px;
      margin-bottom: 12px;
    }

    /* Tables */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 10pt;
    }

    th {
      background: #f5f5f3;
      padding: 8px 12px;
      text-align: left;
      font-weight: bold;
      border-bottom: 2px solid #ddd;
      font-size: 9pt;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    td {
      padding: 8px 12px;
      border-bottom: 1px solid #eee;
      vertical-align: middle;
    }

    tr:last-child td {
      border-bottom: none;
    }

    /* Status badges */
    .status {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 3px;
      font-size: 9pt;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .status.safe { background: #dcfce7; color: #166534; }
    .status.warning { background: #fef3c7; color: #92400e; }
    .status.danger { background: #fee2e2; color: #991b1b; }
    .status.breach { background: #991b1b; color: white; }
    .status.suspended { background: #e5e7eb; color: #374151; }
    .status.achieved { background: #dcfce7; color: #166534; }
    .status.in_progress { background: #dbeafe; color: #1e40af; }
    .status.at_risk { background: #fee2e2; color: #991b1b; }
    .status.pending { background: #f3f4f6; color: #6b7280; }

    /* Headroom bar */
    .headroom-bar {
      width: 100px;
      height: 8px;
      background: #e5e7eb;
      border-radius: 4px;
      overflow: hidden;
      display: inline-block;
      vertical-align: middle;
      margin-right: 8px;
    }

    .headroom-fill {
      height: 100%;
      border-radius: 4px;
    }

    .headroom-fill.safe { background: #22c55e; }
    .headroom-fill.warning { background: #eab308; }
    .headroom-fill.danger { background: #ef4444; }
    .headroom-fill.breach { background: #dc2626; }

    /* Footer */
    .footer {
      margin-top: 32px;
      padding-top: 16px;
      border-top: 1px solid #ddd;
      font-size: 9pt;
      color: #666;
      display: flex;
      justify-content: space-between;
    }

    .footer .branding {
      font-weight: bold;
      color: #B8860B;
    }

    /* Print styles */
    @media print {
      body {
        padding: 0;
      }

      .section {
        page-break-inside: avoid;
      }

      @page {
        margin: 0.75in;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <h1>Compliance Certificate</h1>
    <div class="subtitle">Quarterly Financial Covenant Certification</div>
    <div class="project-name">${t.project.name}</div>
  </div>

  <!-- Metadata -->
  <div class="metadata">
    <div class="metadata-item">
      <strong>Facility:</strong> ${t.project.facility}
    </div>
    <div class="metadata-item">
      <strong>Borrower:</strong> ${t.project.borrower||t.project.sponsor}
    </div>
    <div class="metadata-item">
      <strong>Date:</strong> ${pa(n)}
    </div>
    <div class="metadata-item">
      <strong>Phase:</strong> ${t.phase.current}
    </div>
  </div>

  <!-- Summary -->
  <div class="summary-box">
    <h2>Executive Summary</h2>
    <div class="summary-grid">
      <div class="summary-stat">
        <div class="value">${t.covenants.filter(s=>s.compliant&&!s.suspended).length}/${t.covenants.filter(s=>!s.suspended).length}</div>
        <div class="label">Covenants Passing</div>
      </div>
      <div class="summary-stat">
        <div class="value">${t.milestones.filter(s=>s.status==="achieved").length}/${t.milestones.length}</div>
        <div class="label">Milestones Achieved</div>
      </div>
      <div class="summary-stat">
        <div class="value">${t.reserves.length>0?Me(t.reserves.reduce((s,r)=>s+r.balance,0)/t.reserves.reduce((s,r)=>s+r.target,0)*100):"N/A"}</div>
        <div class="label">Reserve Funding</div>
      </div>
      <div class="summary-stat">
        <div class="value">${t.conditionsPrecedent.reduce((s,r)=>s+r.conditions.filter(l=>l.status==="satisfied"||l.status==="waived").length,0)}/${t.conditionsPrecedent.reduce((s,r)=>s+r.conditions.length,0)}</div>
        <div class="label">CPs Satisfied</div>
      </div>
    </div>
  </div>

  <!-- Covenants -->
  <div class="section">
    <h2>Financial Covenants</h2>
    <table>
      <thead>
        <tr>
          <th>Covenant</th>
          <th>Actual</th>
          <th>Required</th>
          <th>Headroom</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        ${t.covenants.map(s=>{const r=ga(s),l=Math.min(100,Math.max(0,s.headroom??0));return`
            <tr>
              <td><strong>${s.name}</strong></td>
              <td>${lt(s.actual)}</td>
              <td>${s.operator} ${lt(s.required)}</td>
              <td>
                <div class="headroom-bar">
                  <div class="headroom-fill ${r}" style="width: ${l}%"></div>
                </div>
                ${Me(s.headroom??0)}
              </td>
              <td><span class="status ${r}">${fa(r)}</span></td>
            </tr>
          `}).join("")}
      </tbody>
    </table>
  </div>

  ${t.milestones.length>0?`
  <!-- Milestones -->
  <div class="section">
    <h2>Construction Milestones</h2>
    <table>
      <thead>
        <tr>
          <th>Milestone</th>
          <th>Target Date</th>
          <th>Longstop Date</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        ${t.milestones.map(s=>`
          <tr>
            <td><strong>${s.name}</strong></td>
            <td>${s.target||"TBD"}</td>
            <td>${s.longstop||"TBD"}</td>
            <td><span class="status ${s.status}">${ja(s.status)}</span></td>
          </tr>
        `).join("")}
      </tbody>
    </table>
  </div>
  `:""}

  ${t.reserves.length>0?`
  <!-- Reserves -->
  <div class="section">
    <h2>Reserve Accounts</h2>
    <table>
      <thead>
        <tr>
          <th>Reserve</th>
          <th>Balance</th>
          <th>Target</th>
          <th>Minimum</th>
          <th>Funding %</th>
        </tr>
      </thead>
      <tbody>
        ${t.reserves.map(s=>{const r=s.balance/s.target*100;return`
            <tr>
              <td><strong>${s.name}</strong></td>
              <td>${Le(s.balance)}</td>
              <td>${Le(s.target)}</td>
              <td>${Le(s.minimum)}</td>
              <td>${Me(r)}</td>
            </tr>
          `}).join("")}
      </tbody>
    </table>
  </div>
  `:""}

  <!-- Footer -->
  <div class="footer">
    <div>
      This certificate was automatically generated from ProViso compliance data.
    </div>
    <div class="branding">
      ProViso | proviso-demo.haslun.online
    </div>
  </div>
</body>
</html>
`}function Na(t,n,s){return{exportedAt:new Date().toISOString(),version:"2.3.0",project:{name:t.project.name,facility:t.project.facility,sponsor:t.project.sponsor,borrower:t.project.borrower},currentPhase:t.phase.current,financials:s,covenants:t.covenants,milestones:t.milestones,reserves:t.reserves,code:n}}function Ue(t,n,s="text/plain"){const r=new Blob([t],{type:s}),l=URL.createObjectURL(r),i=document.createElement("a");i.href=l,i.download=n,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(l)}const va=[{id:"pdf",title:"Compliance Certificate",description:"Print-ready compliance report with covenant status and headroom",icon:as,format:"PDF"},{id:"word",title:"Credit Agreement",description:"Legal document with all definitions, covenants, and baskets",icon:ue,format:"TXT"},{id:"json",title:"Raw Data Export",description:"Complete interpreter state with financials and results",icon:Oe,format:"JSON"},{id:"proviso",title:"ProViso Source Code",description:"Download the ProViso agreement definition file",icon:Nt,format:".proviso"}];function ya({isOpen:t,onClose:n,dashboardData:s,provisoCode:r,financials:l}){const[i,c]=g.useState(null),[d,x]=g.useState(new Set),a=async m=>{if(s){c(m);try{const h=wa(s.project.name,m);switch(m){case"pdf":{const p=ba(s);Ca(p,s.project.name);break}case"word":{const p=js(r,{dealName:s.project.name,facilityAmount:s.financials.total_project_cost});bs(p,h);break}case"json":{const p=Na(s,r,l);Ue(JSON.stringify(p,null,2),h,"application/json");break}case"proviso":{Ue(r,h,"text/plain");break}}gs(m),x(p=>new Set(p).add(m))}catch(h){console.error("Export failed:",h)}finally{c(null)}}},o=()=>{x(new Set),n()};return e.jsx(le,{isOpen:t,onClose:o,title:"Export Report",size:"md",children:e.jsxs("div",{className:"space-y-2",children:[e.jsxs("p",{className:"text-sm text-text-tertiary mb-4",children:["Export compliance data and agreement documents for"," ",e.jsx("span",{className:"text-text-secondary font-medium",children:(s==null?void 0:s.project.name)||"this project"})]}),e.jsx("div",{className:"space-y-3",children:va.map(m=>{const h=m.icon,p=i===m.id,u=d.has(m.id);return e.jsxs("div",{className:`
                  group flex items-center gap-4 p-4
                  bg-surface-2 border border-border-subtle rounded-xl
                  hover:border-border-DEFAULT hover:bg-surface-3
                  transition-all duration-150
                `,children:[e.jsx("div",{className:`
                    w-10 h-10 flex items-center justify-center
                    bg-surface-3 border border-border-subtle rounded-lg
                    group-hover:border-gold-600/30 group-hover:bg-gold-600/10
                    transition-all duration-150
                  `,children:e.jsx(h,{className:"w-5 h-5 text-text-tertiary group-hover:text-gold-500 transition-colors"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h4",{className:"text-sm font-medium text-text-primary",children:m.title}),e.jsx("span",{className:"px-1.5 py-0.5 text-xs bg-surface-3 text-text-muted rounded",children:m.format})]}),e.jsx("p",{className:"text-xs text-text-tertiary mt-0.5 truncate",children:m.description})]}),e.jsx(I,{variant:u?"secondary":"ghost",size:"sm",onClick:()=>a(m.id),disabled:p||!s,icon:p?e.jsx(me,{className:"w-4 h-4 animate-spin"}):u?e.jsx(Ce,{className:"w-4 h-4 text-green-500"}):e.jsx(vt,{className:"w-4 h-4"}),children:p?"Exporting...":u?"Downloaded":"Export"})]},m.id)})}),e.jsxs("div",{className:"mt-6 pt-4 border-t border-border-subtle flex items-center justify-between",children:[e.jsxs("p",{className:"text-xs text-text-muted",children:["Generated by ProViso at ",new Date().toLocaleDateString()]}),e.jsx(I,{variant:"ghost",size:"sm",onClick:o,children:"Close"})]})]})})}function wa(t,n){const s=t.replace(/[^a-zA-Z0-9]/g,"-").toLowerCase(),r=new Date().toISOString().split("T")[0];switch(n){case"pdf":return`${s}-compliance-${r}.pdf`;case"word":return`${s}-credit-agreement-${r}.txt`;case"json":return`${s}-export-${r}.json`;case"proviso":return`${s}.proviso`;default:return`${s}-export-${r}`}}function Ca(t,n){const s=window.open("","_blank","width=800,height=600");if(!s){console.error("Failed to open print window");return}s.document.write(t),s.document.close(),s.document.title=`${n} - Compliance Certificate`,s.onload=()=>{setTimeout(()=>{s.print()},250)}}const Pe=`// Desert Sun Solar Project
// $280M Construction + Term Loan
// ProViso v2.1

// ==================== PHASES ====================

PHASE Construction
  UNTIL COD_Achieved
  COVENANTS SUSPENDED TotalLeverage, MinDSCR
  REQUIRED MinEquityContribution

PHASE Operations
  FROM COD_Achieved
  COVENANTS ACTIVE TotalLeverage, SeniorLeverage, InterestCoverage, MinDSCR

TRANSITION COD_Achieved
  WHEN ALL_OF(
    SubstantialCompletion,
    GridSynchronization,
    FinalInspection
  )

// ==================== MILESTONES ====================

MILESTONE SitePrepComplete
  TARGET 2025-03-15
  LONGSTOP 2025-05-15
  TRIGGERS Draw2Available

MILESTONE PileInstallation
  TARGET 2025-06-30
  LONGSTOP 2025-09-30
  REQUIRES SitePrepComplete
  TRIGGERS Draw3Available

MILESTONE TrackerInstallation
  TARGET 2025-09-30
  LONGSTOP 2025-12-31
  REQUIRES PileInstallation

MILESTONE ModuleInstallation
  TARGET 2025-12-15
  LONGSTOP 2026-03-15
  REQUIRES TrackerInstallation
  TRIGGERS Draw4Available

MILESTONE InverterCommissioning
  TARGET 2026-02-28
  LONGSTOP 2026-05-31
  REQUIRES ModuleInstallation

// AT-RISK: Only 5 days until longstop!
MILESTONE SubstationComplete
  TARGET 2026-01-31
  LONGSTOP 2026-02-10
  REQUIRES TrackerInstallation
  TRIGGERS SubstationCertification

MILESTONE GridSynchronization
  TARGET 2026-04-15
  LONGSTOP 2026-07-15
  REQUIRES ALL_OF(InverterCommissioning, SubstationComplete)

MILESTONE SubstantialCompletion
  TARGET 2026-04-30
  LONGSTOP 2026-07-31
  REQUIRES ALL_OF(GridSynchronization, FinalInspection)
  TRIGGERS COD_Achieved

// ==================== DEFINITIONS ====================

DEFINE EBITDA AS
  net_income + interest_expense + tax_expense + depreciation + amortization

DEFINE TotalDebt AS
  senior_debt + subordinated_debt

DEFINE SeniorDebt AS
  senior_debt

DEFINE DebtService AS
  senior_interest + senior_principal

DEFINE DSCR AS
  EBITDA / DebtService

DEFINE Leverage AS
  TotalDebt / EBITDA

DEFINE SeniorLeverage AS
  SeniorDebt / EBITDA

// ==================== COVENANTS ====================

// NEAR-BREACH: Leverage at ~4.35x vs 4.50x threshold (97%)
COVENANT TotalLeverage
  REQUIRES Leverage <= 4.50
  TESTED QUARTERLY

COVENANT SeniorLeverage
  REQUIRES SeniorLeverage <= 3.50
  TESTED QUARTERLY

// Has cure clause - previously used in Q2 2025
COVENANT InterestCoverage
  REQUIRES EBITDA / interest_expense >= 2.50
  TESTED QUARTERLY
  CURE EquityCure MAX_USES 3 OVER life_of_facility

COVENANT MinDSCR
  REQUIRES DSCR >= 1.25
  TESTED QUARTERLY

COVENANT MinEquityContribution
  REQUIRES equity_contributed >= 0.30 * total_project_cost
  TESTED MONTHLY

// ==================== RESERVES ====================

RESERVE DebtServiceReserve
  TARGET 6 * monthly_debt_service
  MINIMUM 3 * monthly_debt_service
  FUNDED_BY Waterfall, EquityContribution
  RELEASED_TO Waterfall

RESERVE MaintenanceReserve
  TARGET annual_capex_budget
  MINIMUM 0.5 * annual_capex_budget
  FUNDED_BY Waterfall
  RELEASED_FOR PermittedCapEx

// ==================== WATERFALL ====================

WATERFALL OperatingWaterfall
  FREQUENCY monthly

  TIER 1 "Operating Expenses"
    PAY operating_expenses
    FROM Revenue

  TIER 2 "Senior Debt Service"
    PAY senior_interest + senior_principal
    FROM REMAINDER
    SHORTFALL -> DebtServiceReserve

  TIER 3 "DSRA Replenishment"
    PAY TO DebtServiceReserve
    UNTIL DebtServiceReserve >= 6 * monthly_debt_service
    FROM REMAINDER

  TIER 4 "Maintenance Reserve"
    PAY TO MaintenanceReserve
    UNTIL MaintenanceReserve >= annual_capex_budget
    FROM REMAINDER

  TIER 5 "Distributions"
    IF DSCR >= 1.50
    PAY distributions
    FROM REMAINDER

// ==================== TAX EQUITY ====================

TAX_EQUITY_STRUCTURE SolarPartnership
  STRUCTURE_TYPE partnership_flip
  TAX_INVESTOR "Tax Equity Fund LP"
  SPONSOR "Desert Sun Holdings LLC"
  TAX_CREDIT_ALLOCATION 99% investor, 1% sponsor
  DEPRECIATION_ALLOCATION 99% investor, 1% sponsor
  CASH_ALLOCATION 10% investor, 90% sponsor
  TARGET_RETURN 8.0%
  BUYOUT_PRICE $5_000_000

TAX_CREDIT SolarITC
  CREDIT_TYPE itc
  RATE 30%
  ADDER domestic_content 10%
  ADDER energy_community 10%
  ELIGIBLE_BASIS $240_000_000
  VESTING_PERIOD 5 YEARS
  RECAPTURE_RISK 20% per year

DEPRECIATION_SCHEDULE SolarMACRS
  METHOD macrs_5yr
  DEPRECIABLE_BASIS $240_000_000
  BONUS_DEPRECIATION 60%

FLIP_EVENT TargetReturnFlip
  TRIGGER target_return
  TARGET_RETURN 8.0%
  PRE_FLIP_ALLOCATION 99% investor, 1% sponsor
  POST_FLIP_ALLOCATION 5% investor, 95% sponsor
  BUYOUT_OPTION fair_market_value

// ==================== TECHNICAL MILESTONES ====================

TECHNICAL_MILESTONE PileProgress
  TARGET 2025-06-30
  LONGSTOP 2025-09-30
  MEASUREMENT "piles driven"
  TARGET_VALUE 45000
  CURRENT_VALUE 38500
  PROGRESS_METRIC 85.6%

TECHNICAL_MILESTONE ModuleProgress
  TARGET 2025-12-15
  LONGSTOP 2026-03-15
  MEASUREMENT "MW installed"
  TARGET_VALUE 200
  CURRENT_VALUE 140
  PROGRESS_METRIC 70%

// ==================== PERFORMANCE GUARANTEES ====================

PERFORMANCE_GUARANTEE AnnualProduction
  METRIC annual_gwh
  P50 520
  P75 495
  P90 470
  P99 440
  GUARANTEE_PERIOD 10 YEARS
  SHORTFALL_RATE $50 per MWh

PERFORMANCE_GUARANTEE AvailabilityGuarantee
  METRIC availability_pct
  P50 99.0
  P75 98.5
  P90 97.5
  P99 96.0
  GUARANTEE_PERIOD 25 YEARS

// ==================== DEGRADATION ====================

DEGRADATION_SCHEDULE PanelDegradation
  ASSET_TYPE "bifacial_mono_perc"
  INITIAL_CAPACITY 200
  YEAR_1_DEGRADATION 2.0%
  ANNUAL_DEGRADATION 0.4%
  MINIMUM_CAPACITY 80%
  AFFECTS annual_gwh

// ==================== CONDITIONS PRECEDENT ====================

CONDITIONS_PRECEDENT InitialFunding
  SECTION "4.01"

  CP ExecutedCreditAgreement
    DESCRIPTION "Executed Credit Agreement and all Loan Documents"
    RESPONSIBLE Agent
    STATUS satisfied

  CP LegalOpinions
    DESCRIPTION "Opinions of Borrower's Counsel and Local Counsel"
    RESPONSIBLE BorrowerCounsel
    STATUS satisfied

  CP EquityContribution
    DESCRIPTION "Evidence of Initial Equity Contribution"
    RESPONSIBLE Sponsor
    STATUS satisfied
    SATISFIES MinEquityContribution

  CP InsuranceCertificates
    DESCRIPTION "Evidence of Required Insurance Coverage"
    RESPONSIBLE Borrower
    STATUS satisfied

  CP TaxEquityDocuments
    DESCRIPTION "Executed Tax Equity Partnership Agreement"
    RESPONSIBLE TaxCounsel
    STATUS satisfied

CONDITIONS_PRECEDENT Draw4
  SECTION "4.02(d)"

  CP Draw4LienSearch
    DESCRIPTION "Updated Lien Search Results"
    RESPONSIBLE Agent
    STATUS pending

  CP Draw4TitleEndorsement
    DESCRIPTION "Date-Down Title Endorsement"
    RESPONSIBLE Borrower
    STATUS pending

  CP Draw4Inspection
    DESCRIPTION "Module Installation Inspection"
    RESPONSIBLE EngineeringConsultant
    STATUS pending

  CP SubstationCert
    DESCRIPTION "Substation Completion Certificate"
    RESPONSIBLE Borrower
    STATUS pending
`;function ct(t){return/Q\d/i.test(t)?"quarterly":/^\d{4}$/.test(t.trim())?"annual":"monthly"}function ot(t,n,s){const r=t.map(l=>({period:l.period,periodType:ct(l.period),periodEnd:l.periodEnd,data:{...l.data}}));if(n&&s&&!r.some(i=>i.period===s)){const c=new Date().toISOString().split("T")[0];r.push({period:s,periodType:ct(s),periodEnd:c,data:{...n}})}return{periods:r}}function dt(){const t=new Date;return`Q${Math.ceil((t.getMonth()+1)/3)} ${t.getFullYear()}`}function Ea(){return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"bg-surface-0/50 border border-surface-2 rounded-xl p-5",children:e.jsx("div",{className:"grid grid-cols-4 gap-4",children:[1,2,3,4].map(t=>e.jsxs("div",{className:"space-y-2",children:[e.jsx(be,{width:"60%",height:"14px"}),e.jsx(be,{width:"40%",height:"24px"})]},t))})}),e.jsxs("div",{className:"bg-surface-0/50 border border-surface-2 rounded-xl p-5",children:[e.jsx(be,{width:"150px",height:"16px",className:"mb-4"}),e.jsx(be,{width:"100%",height:"60px"})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsx(Ne,{}),e.jsxs("div",{className:"space-y-6",children:[e.jsx(zt,{height:"200px"}),e.jsx(Ne,{})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsx(Ne,{}),e.jsx(Ne,{})]})]})]})}function Ta({error:t,onRetry:n}){return e.jsx("div",{className:"min-h-[400px] flex items-center justify-center",children:e.jsx(mt,{icon:V,title:"Failed to load dashboard",description:t,action:{label:"Retry",onClick:n,variant:"primary",icon:e.jsx(We,{className:"w-4 h-4"})},size:"lg"})})}function Ba(){var Qe;const{dealId:t}=Ut(),{isLoaded:n,isLoading:s,error:r,dashboardData:l,code:i,financials:c,isMultiPeriod:d,loadFromCode:x,refresh:a}=te(),{logActivity:o,getActivitiesForDeal:m,currentDeal:h,getPartiesForDeal:p}=_t(),u=t?m(t):[],[j,N]=g.useState(!1),[E,D]=g.useState(!1),[y,b]=g.useState(!1),[w,v]=g.useState(!1),[f,S]=g.useState(!1),[F,M]=g.useState(!1),[$,_]=g.useState(null),k=t?$e(t):void 0,K=(k==null?void 0:k.code)??Pe,oe=(k==null?void 0:k.financials)??ae,[W,R]=g.useState(null),A=g.useMemo(()=>{if(!l)return null;if(h&&t){const T=p(t),L=T.find(G=>G.partyType==="borrower"),P=T.find(G=>{var je;return(je=G.role)==null?void 0:je.toLowerCase().includes("sponsor")});return{...l,project:{name:l.project.name||h.name,facility:l.project.facility||`$${(h.facilityAmount/1e6).toFixed(0)}M ${h.dealType==="project_finance"?"Project Finance":"Corporate"} Facility`,sponsor:l.project.sponsor||(P==null?void 0:P.name)||"",borrower:l.project.borrower||(L==null?void 0:L.name)||h.name}}}return l},[l,h,t,p]);g.useEffect(()=>{async function T(){var P;if(!n&&!s&&!r||t!==W&&!s){const G=t?$e(t):void 0;if(G){const je=((P=G.historicalData)==null?void 0:P.length)>0?ot(G.historicalData,G.financials,dt()):void 0;await x(G.code,G.financials,je)}else await x(Pe,ae);R(t??null)}}T()},[t,W,n,s,r,x]);const de=async()=>{var L;const T=t?$e(t):void 0;if(T){const P=((L=T.historicalData)==null?void 0:L.length)>0?ot(T.historicalData,T.financials,dt()):void 0;await x(T.code,T.financials,P)}else await x(Pe,ae)},C=()=>{a()},O=()=>{N(T=>!T)},H=()=>{D(T=>!T)},It=()=>{t&&o({type:"file_loaded",dealId:t,title:"File uploaded",description:"ProViso file or financial data loaded"}),setTimeout(()=>{D(!1)},1500)},Ft=()=>{const T=i||K,P=((l==null?void 0:l.project.name)||"agreement").replace(/[^a-zA-Z0-9]/g,"-").toLowerCase();Ue(T,`${P}.proviso`,"text/plain")};if(s||!n&&!r||t!==W&&W!==null)return e.jsx(ve,{dealId:t||"unknown",dealName:"Loading...",dealStatus:"active",subtitle:"",children:e.jsx(ye,{children:e.jsx(Ea,{})})});if(r)return e.jsx(ve,{dealId:t||"unknown",dealName:"Error",dealStatus:"active",subtitle:"",children:e.jsx(ye,{children:e.jsx(Ta,{error:r,onRetry:de})})});if(!l||!A)return e.jsx(ve,{dealId:t||"unknown",dealName:"No Data",dealStatus:"active",subtitle:"",children:e.jsx(ye,{children:e.jsx(mt,{title:"No data available",description:"Load a ProViso file to see dashboard data.",size:"lg"})})});const kt=A.covenants.filter(T=>!T.compliant&&!T.suspended),Lt=(T,L,P)=>{t&&o({type:"covenant_alert",dealId:t,title:"Cure applied",description:`${L} of $${P.toLocaleString()} applied to ${T}`}),a()},Mt=()=>{t&&$&&o({type:"covenant_alert",dealId:t,title:"Waiver request submitted",description:`Waiver requested for ${$.name}`})},Pt=T=>{t&&o({type:"covenant_alert",dealId:t,title:"Amendment drafted",description:`Amendment code generated (${T.split(`
`).length} lines)`})},Ot=(Qe=A.phase.current)!=null&&Qe.toLowerCase().includes("construction")?"construction":"operations";return e.jsxs(ve,{dealId:t||"unknown",dealName:A.project.name,dealStatus:"active",subtitle:A.project.facility,currentPhase:Ot,actions:e.jsxs(e.Fragment,{children:[e.jsx(I,{variant:"ghost",icon:e.jsx(we,{className:"w-4 h-4"}),size:"sm",onClick:H,children:"Upload"}),e.jsx(I,{variant:j?"secondary":"ghost",icon:e.jsx(re,{className:"w-4 h-4"}),size:"sm",onClick:O,children:j?"Hide Editor":"Edit Financials"}),e.jsx(I,{variant:"ghost",icon:e.jsx(We,{className:"w-4 h-4"}),size:"sm",onClick:C,children:"Refresh"}),e.jsx(I,{variant:"ghost",icon:e.jsx(vt,{className:"w-4 h-4"}),size:"sm",onClick:Ft,children:"Download Code"}),e.jsx(I,{variant:"ghost",icon:e.jsx(ue,{className:"w-4 h-4"}),size:"sm",onClick:()=>b(!0),children:"Export Report"})]}),children:[j&&e.jsxs("div",{className:"fixed inset-y-0 right-0 w-full sm:w-[480px] z-50 flex",children:[e.jsx("div",{className:"fixed inset-0 bg-black/50 sm:hidden",onClick:()=>N(!1)}),e.jsxs("div",{className:"relative ml-auto w-full sm:w-[480px] bg-surface-0 border-l border-surface-2 shadow-2xl overflow-y-auto",children:[e.jsx("button",{onClick:()=>N(!1),className:"absolute top-4 right-4 p-2 rounded-lg bg-surface-2 hover:bg-surface-3 text-text-tertiary hover:text-text-primary transition-colors z-10",children:e.jsx(ze,{className:"w-5 h-5"})}),e.jsx("div",{className:"pt-4",children:e.jsx(ma,{onClose:()=>N(!1)})})]})]}),e.jsx(le,{isOpen:E,onClose:()=>D(!1),title:"Upload Files",size:"md",children:e.jsx(ha,{onSuccess:It,demoMode:!!k})}),e.jsx(ya,{isOpen:y,onClose:()=>b(!1),dashboardData:l,provisoCode:i||K,financials:Object.keys(c).length>0?c:oe}),e.jsx(Xs,{isOpen:w,onClose:()=>v(!1),covenant:$,onCureApplied:Lt}),e.jsx(ea,{isOpen:f,onClose:()=>S(!1),covenant:$,allBreachedCovenants:kt,onSubmit:Mt,dealName:A.project.name,borrowerName:A.project.borrower||A.project.sponsor}),e.jsx(aa,{isOpen:F,onClose:()=>M(!1),currentCode:i||K,triggerCovenant:$,onGenerate:Pt}),e.jsxs(ye,{children:[e.jsx(Es,{data:A}),e.jsx("div",{className:"mt-6",children:e.jsx(As,{phase:A.phase})}),e.jsxs("div",{className:"mt-6 grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 lg:gap-6",children:[e.jsxs("div",{className:"min-w-[280px] md:col-span-2 xl:col-span-1 space-y-4 lg:space-y-6",children:[e.jsx(Fs,{covenants:A.covenants,onRequestCure:T=>{_(T),v(!0)},onRequestWaiver:T=>{_(T),S(!0)},onRequestAmendment:T=>{_(T),M(!0)}}),A.baskets.length>0&&e.jsxs("div",{className:"bg-surface-0/80 backdrop-blur-sm border border-surface-2 rounded-xl overflow-hidden",children:[e.jsx("div",{className:"p-4 border-b border-surface-2",children:e.jsx("h3",{className:"text-sm font-semibold text-text-primary",children:"Basket Utilization"})}),e.jsx("div",{className:"p-4 space-y-3",children:A.baskets.map(T=>{const L=Math.min(T.utilization,100),P=L>=90?"bg-danger":L>=75?"bg-warning":"bg-accent";return e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("span",{className:"text-xs font-medium text-text-primary",children:T.name}),e.jsxs("span",{className:"text-xs text-text-secondary",children:[L.toFixed(0),"% used"]})]}),e.jsx("div",{className:"w-full h-2 bg-surface-2 rounded-full overflow-hidden",children:e.jsx("div",{className:`h-full rounded-full ${P}`,style:{width:`${L}%`}})}),e.jsxs("div",{className:"flex justify-between mt-0.5",children:[e.jsxs("span",{className:"text-[10px] text-text-tertiary",children:["$",T.used>=1e6?`${(T.used/1e6).toFixed(1)}M`:`${(T.used/1e3).toFixed(0)}K`," used"]}),e.jsxs("span",{className:"text-[10px] text-text-tertiary",children:["$",T.available>=1e6?`${(T.available/1e6).toFixed(1)}M`:`${(T.available/1e3).toFixed(0)}K`," available"]})]})]},T.name)})})]})]}),e.jsxs("div",{className:"min-w-[280px] space-y-4 lg:space-y-6",children:[e.jsx(ks,{waterfall:A.waterfall}),e.jsx(Ls,{reserves:A.reserves})]}),e.jsxs("div",{className:"min-w-[280px] space-y-4 lg:space-y-6",children:[e.jsx(Ps,{milestones:A.milestones}),e.jsx(_s,{checklists:A.conditionsPrecedent})]})]}),e.jsx("div",{className:"mt-8",children:e.jsx(Fe,{title:"Scenario Analysis",subtitle:"Test 'what if' scenarios on covenant compliance",icon:e.jsx(ie,{className:"w-5 h-5 text-industry-primary"}),defaultExpanded:!1,children:e.jsx(Zs,{})})}),e.jsx("div",{className:"mt-8",children:e.jsx(Fe,{title:"Compliance History",subtitle:d?"Covenant trends from multi-period financial data":"Covenant trends over time (simulated historical data)",icon:e.jsx(rs,{className:"w-5 h-5 text-industry-primary"}),defaultExpanded:!1,children:e.jsx(Ws,{periods:6})})}),A.industry&&e.jsx("div",{className:"mt-8",children:e.jsx(Fe,{title:"Industry Analytics",subtitle:"Performance, regulatory, and tax equity tracking",icon:e.jsx(ns,{className:"w-5 h-5 text-industry-primary"}),defaultExpanded:!1,children:e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[A.industry.performanceGuarantees&&e.jsx(ra,{guarantees:A.industry.performanceGuarantees,degradation:A.industry.degradation}),A.industry.technicalMilestones&&e.jsx(ia,{milestones:A.industry.technicalMilestones}),A.industry.regulatoryRequirements&&e.jsx(na,{requirements:A.industry.regulatoryRequirements}),A.industry.taxEquity&&e.jsx(la,{structure:A.industry.taxEquity.structure,credits:A.industry.taxEquity.credits,depreciation:A.industry.taxEquity.depreciation,flipEvents:A.industry.taxEquity.flipEvents})]})})}),u.length>0&&e.jsx("div",{className:"mt-8",children:e.jsx(Bt,{activities:u,title:"Recent Activity",maxItems:5,defaultExpanded:!1})})]})]})}export{Ba as MonitoringDashboard,Ba as default};
